<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Skytrix</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for Service Sheet Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        /* Hide all views by default */
        .view {
            display: none;
        }

        /* Show the active view */
        .view.active {
            display: block;
        }

        /* Simple transition for modals if needed */
        #modal-container, #gemini-modal-container {
            transition: opacity 0.3s ease;
        }
        
        /* Custom scrollbar for modal content */
        #modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
         @media print {
             body * {
                 visibility: hidden;
             }
             #hoja-servicio-printable, #hoja-servicio-printable * {
                 visibility: visible;
             }
             #hoja-servicio-printable {
                 position: absolute;
                 left: 0;
                 top: 0;
                 width: 100%;
             }
         }
    </style>
</head>
<body class="font-sans">

    <!-- Login Screen -->
    <div id="login-container" class="flex flex-col min-h-screen" style="background-color: #000414;">
        <div class="flex-grow flex items-center justify-center p-4">
            <div class="relative w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                 <!-- Loading Overlay -->
                <div id="login-loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-lg z-20">
                    <div class="text-center">
                        <i data-lucide="loader" class="animate-spin text-indigo-600 h-10 w-10 mx-auto"></i>
                        <p class="mt-4 text-gray-700 font-semibold">Verificando...</p>
                    </div>
                </div>
                <div class="text-center">
                    <img src="https://i.ibb.co/wNwZwRsM/logo-skytrix.png" alt="Logo de Skytrix" class="w-20 h-20 mx-auto">
                    <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                        Sistema de Gestión <span style="color: #028092;">Skytrix GPS</span>
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">
                        Inicia sesión para continuar
                    </p>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="username" class="sr-only">Usuario</label>
                            <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Usuario">
                        </div>
                        <div>
                            <label for="password" class="sr-only">Contraseña</label>
                            <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Contraseña">
                        </div>
                    </div>

                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                <i data-lucide="lock" class="h-5 w-5 text-indigo-500 group-hover:text-indigo-400"></i>
                            </span>
                            Iniciar Sesión
                        </button>
                    </div>
                     <p id="login-error" class="mt-2 text-center text-sm text-red-600"></p>
                </form>
            </div>
        </div>
        <footer style="background-color: #000414;" class="shadow-inner py-6 text-center text-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <p class="font-semibold" style="color: #00d6d7;">Skytrix GPS: Tu Mundo Bajo Control | Soluciones de rastreo satelital confiables.</p>
                <p class="mt-2 text-white">© 2025 Skytrix GPS. Todos los derechos reservados.</p>
                <div class="flex justify-center space-x-6 mt-4">
                    <a href="https://www.facebook.com/skytrix.gps" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i class="fab fa-facebook-f fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/skytrix.gps" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://micodus.net" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i data-lucide="map-pin" style="width:20px; height:20px;"></i>
                    </a>
                </div>
            </div>
        </footer>
    </div>


    <div id="app-container" class="hidden flex flex-col min-h-screen bg-gray-100">
        <!-- Header -->
        <header style="background-color: #000414;" class="shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <img src="https://i.ibb.co/wNwZwRsM/logo-skytrix.png" alt="Logo de Skytrix" class="h-8 w-8 mr-2">
                        <h1 class="text-xl font-bold" style="color: #00d6d7;">Sistema de Gestión Skytrix</h1>
                    </div>
                    <div class="flex-1 max-w-xl mx-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" style="width:20px; height:20px;"></i>
                            <input type="text" id="search-term" placeholder="Buscar por cliente, GPS, placas, VIN, Nickname o Línea SIM..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-id-display" class="text-xs text-gray-300"></div>
                        <button id="logout-btn" class="text-red-400 hover:text-red-200" title="Cerrar Sesión">
                            <i data-lucide="log-out" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-grow">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <aside class="lg:col-span-1">
                    <nav class="bg-white p-4 rounded-lg shadow-md space-y-2" id="sidebar-nav">
                        <button data-view="dashboard" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Dashboard</button>
                        <button data-view="kpis-ventas" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">KPIs Ventas</button>
                        <button data-view="kpis-servicios" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">KPIs Servicios</button>
                        <button data-view="comisiones" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Comisiones</button>
                        <button data-view="contrato-de-servicios" id="nav-contrato-de-servicios" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Contratos de Servicios</button>
                        <button data-view="actas-de-servicio" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Actas de Servicio</button>
                        <button data-view="personnel" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Personal Skytrix</button>
                        <button data-view="ventas" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Ventas Skytrix</button>
                        <button data-view="servicios-skytrix" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Servicios Skytrix</button>
                        <button data-view="clients" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Clientes</button>
                        <button data-view="vehicles" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Vehículos</button>
                        <button data-view="sims" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Gestión de SIMs</button>
                        <button data-view="gps" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Equipos GPS</button>
                        <button data-view="backups" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Respaldos</button>
                        <!-- TODO: Restrict visibility to Admin role -->
                        <button data-view="activity-log" class="nav-button w-full text-left flex items-center px-4 py-2 rounded-md">Registro de Actividad</button>
                    </nav>
                </aside>

                <!-- Content Area -->
                <main class="lg:col-span-3" id="main-content">
                    <!-- Views will be injected here by JavaScript -->
                    <div id="view-dashboard" class="view"></div>
                    <div id="view-kpis-ventas" class="view"></div>
                    <div id="view-kpis-servicios" class="view"></div>
                    <div id="view-comisiones" class="view"></div>
                    <div id="view-contrato-de-servicios" class="view"></div>
                    <div id="view-search-results" class="view"></div>
                    <div id="view-gps" class="view"></div>
                    <div id="view-clients" class="view"></div>
                    <div id="view-vehicles" class="view"></div>
                    <div id="view-personnel" class="view"></div>
                    <div id="view-sims" class="view"></div>
                    <div id="view-ventas" class="view"></div>
                    <div id="view-servicios-skytrix" class="view"></div>
                    <div id="view-backups" class="view"></div>
                    <div id="view-activity-log" class="view"></div>
                </main>
            </div>
        </div>
         <!-- Footer -->
        <footer style="background-color: #000414;" class="shadow-inner mt-8 py-6 text-center text-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <p class="font-semibold" style="color: #00d6d7;">Skytrix GPS: Tu Mundo Bajo Control | Soluciones de rastreo satelital confiables.</p>
                <p class="mt-2 text-white">© 2025 Skytrix GPS. Todos los derechos reservados.</p>
                <div class="flex justify-center space-x-6 mt-4">
                    <a href="https://www.facebook.com/skytrix.gps" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i class="fab fa-facebook-f fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/skytrix.gps" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://micodus.net" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition">
                        <i data-lucide="map-pin" style="width:20px; height:20px;"></i>
                    </a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-800"></h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" style="width:24px; height:24px;"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Gemini Response Modal -->
    <div id="gemini-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="gemini-modal-title" class="text-lg font-semibold text-gray-800"></h3>
                <button id="gemini-modal-close-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" style="width:24px; height:24px;"></i>
                </button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto">
                <!-- Content for Gemini response -->
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- FIREBASE & AUTH CONFIGURATION ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'skytrix-local-dev';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- PRICING & COMMISSION CONFIGURATION ---
            const PRICES = {
                PACKAGES: {
                    basico_moto: 1449,
                    basico_auto: 1699,
                    sos: 1899,
                    premium: 2299
                },
                ACCESSORIES: {
                    sos: 250,
                    relay: 300,
                    mic: 200,
                    fuel: 1200,
                    temp: 1000,
                    camera: 1800,
                },
                SERVICES: {
                    mensual_250: 250,
                    mensual_300: 300,
                    anual_3000: 3000,
                    anual_3600: 3600,
                }
            };
            const COMMISSION_RATES_SALES = {
                basico_moto: 80,
                basico_auto: 100,
                sos: 120,
                premium: 150
            };
             const COMMISSION_RATES_SERVICES = {
                basico_moto: 100,
                basico_auto: 120,
                sos: 150,
                premium: 200
            };

            // --- STATE & CONFIGURATION ---
            let state = {
                userId: null,
                currentUser: null, // To store logged-in user info
                isAuthReady: false,
                currentView: 'dashboard',
                searchTerm: '',
                kpiPeriodFilter: 'month',
                kpiDateFilter: new Date().toISOString().slice(0, 7), // YYYY-MM
                kpiPersonnelFilter: 'all',
                kpiTechnicianFilter: 'all',
                kpiServiceTypeFilter: 'all',
                commissionTypeFilter: 'vendedores',
                gpsDevices: [],
                clients: [],
                personnel: [],
                vehicles: [],
                sims: [],
                sales: [],
                serviciosSkytrix: [],
                activityLog: [],
                listeners: {} // To store unsubscribe functions
            };

            const mexicanStates = [
                "Aguascalientes", "Baja California", "Baja California Sur", "Campeche", "Chiapas", "Chihuahua", "Ciudad de México", "Coahuila", "Colima", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco", "México", "Michoacán", "Morelos", "Nayarit", "Nuevo León", "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", "Veracruz", "Yucatán", "Zacatecas"
            ];
            
            // --- DATABASE SERVICE (Firestore) ---
            const dbService = {
                getCollectionPath: (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`,
                
                attachListeners: () => {
                    if (!state.isAuthReady) return; // Wait for auth to be ready
                    const collections = ['gpsDevices', 'clients', 'personnel', 'vehicles', 'sims', 'sales', 'serviciosSkytrix', 'activityLog'];
                    collections.forEach(collectionName => {
                        const q = query(collection(db, dbService.getCollectionPath(collectionName)));
                        if (state.listeners[collectionName]) {
                            state.listeners[collectionName]();
                        }
                        state.listeners[collectionName] = onSnapshot(q, (querySnapshot) => {
                            const items = [];
                            querySnapshot.forEach((doc) => {
                                items.push({ id: doc.id, ...doc.data() });
                            });
                            state[collectionName] = items;
                            navigateTo(state.currentView, true);
                        }, (error) => {
                            console.error(`Error listening to ${collectionName}:`, error);
                        });
                    });
                },
                
                detachListeners: () => {
                    for (const key in state.listeners) {
                        state.listeners[key]();
                    }
                    state.listeners = {};
                },

                add: async (collectionName, item) => {
                    try {
                        await addDoc(collection(db, dbService.getCollectionPath(collectionName)), item);
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                },
                update: async (collectionName, id, updatedData) => {
                    try {
                        const docRef = doc(db, dbService.getCollectionPath(collectionName), id);
                        await updateDoc(docRef, updatedData);
                    } catch (e) {
                        console.error("Error updating document: ", e);
                    }
                },
                delete: async (collectionName, id) => {
                     try {
                        await deleteDoc(doc(db, dbService.getCollectionPath(collectionName), id));
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                },
                restore: async (backupData) => {
                    const collections = ['gpsDevices', 'clients', 'personnel', 'vehicles', 'sims', 'sales', 'serviciosSkytrix', 'activityLog'];
                    for (const collectionName of collections) {
                        const data = backupData[collectionName] || [];
                        const currentDocs = await getDocs(collection(db, dbService.getCollectionPath(collectionName)));
                        for (const document of currentDocs.docs) {
                            await deleteDoc(document.ref);
                        }
                        for (const item of data) {
                            const { id, ...itemData } = item; 
                            await addDoc(collection(db, dbService.getCollectionPath(collectionName)), itemData);
                        }
                    }
                }
            };

            // --- DOM ELEMENTS ---
            const mainContent = document.getElementById('main-content');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const geminiModalContainer = document.getElementById('gemini-modal-container');
            
            // --- UTILITY & HELPER FUNCTIONS ---
            const logActivity = async (action) => {
                if (state.currentUser?.rolUsuario === 'Master') return;
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    userName: state.currentUser?.name || state.userId,
                    action: action
                };
                await dbService.add('activityLog', logEntry);
            };

            const openModal = (title, contentHTML) => {
                modalTitle.textContent = title;
                modalContent.innerHTML = contentHTML;
                modalContainer.classList.remove('hidden');
            };

            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContent.innerHTML = '';
            };

            const openGeminiModal = (title, contentHTML) => {
                document.getElementById('gemini-modal-title').textContent = title;
                document.getElementById('gemini-modal-content').innerHTML = contentHTML;
                geminiModalContainer.classList.remove('hidden');
                const copyBtn = document.getElementById('gemini-copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const responseText = document.getElementById('gemini-response-text').textContent;
                        const textArea = document.createElement("textarea");
                        textArea.value = responseText;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            copyBtn.innerHTML = `<i data-lucide="check" class="mr-2" style="width:16px; height:16px;"></i> Copiado!`;
                            lucide.createIcons();
                            setTimeout(() => {
                                copyBtn.innerHTML = `<i data-lucide="copy" class="mr-2" style="width:16px; height:16px;"></i> Copiar`;
                                lucide.createIcons();
                            }, 2000);
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textArea);
                    });
                }
            };
            
            const closeGeminiModal = () => {
                geminiModalContainer.classList.add('hidden');
            };

            const createBadge = (text, bgColor, textColor) => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${textColor}">${text}</span>`;
            
            const locationBadge = (status) => {
                const styles = {
                    almacen: { text: 'Almacén', bg: 'bg-blue-100', textC: 'text-blue-800' },
                    baja: { text: 'Baja', bg: 'bg-red-100', textC: 'text-red-800' },
                    instalado: { text: 'Instalado', bg: 'bg-green-100', textC: 'text-green-800' },
                    laboratorio: { text: 'Laboratorio', bg: 'bg-purple-100', textC: 'text-purple-800' },
                    senuelo: { text: 'Señuelo', bg: 'bg-yellow-100', textC: 'text-yellow-800' },
                    cita_instalacion: { text: 'Cita Instalación', bg: 'bg-teal-100', textC: 'text-teal-800' },
                };
                const style = styles[status] || { text: status, bg: 'bg-gray-100', textC: 'text-gray-800' };
                return createBadge(style.text, style.bg, style.textC);
            };

            const simStatusBadge = (status) => {
                const styles = {
                    almacen_skytrix: { text: 'Almacén Skytrix', bg: 'bg-blue-100', textC: 'text-blue-800' },
                    activada: { text: 'Activada', bg: 'bg-yellow-100', textC: 'text-yellow-800' },
                    asignada: { text: 'Asignada', bg: 'bg-purple-100', textC: 'text-purple-800' },
                    instalada: { text: 'Instalada', bg: 'bg-green-100', textC: 'text-green-800' },
                };
                const style = styles[status] || { text: status, bg: 'bg-gray-100', textC: 'text-gray-800' };
                return createBadge(style.text, style.bg, style.textC);
            };

            const statusBadge = (status) => {
                const styles = {
                    activo: { text: 'Activo', bg: 'bg-green-100', textC: 'text-green-800' },
                    suspendido: { text: 'Suspendido', bg: 'bg-red-100', textC: 'text-red-800' },
                };
                return createBadge(styles[status]?.text || 'Desconocido', styles[status]?.bg || 'bg-gray-100', styles[status]?.textC || 'text-gray-800');
            };

            const paymentBadge = (status) => {
                const styles = {
                    al_corriente: { text: 'Al Corriente', bg: 'bg-green-100', textC: 'text-green-800' },
                    atrasado: { text: 'Atrasado', bg: 'bg-red-100', textC: 'text-red-800' },
                };
                return createBadge(styles[status]?.text || 'Desconocido', styles[status]?.bg || 'bg-gray-100', styles[status]?.textC || 'text-gray-800');
            };

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
            };
            
            const formatVehicleType = (type) => {
                if (!type) return 'N/A';
                return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            };

            // --- GEMINI API CALLER ---
            const generateGeminiContent = async (prompt) => {
                const title = "Sugerencia de IA";
                openGeminiModal(title, `<div class="flex justify-center items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>`);
                const apiKey = ""; // Provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`La solicitud a la API falló con el estado ${response.status}`);
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const contentHTML = `
                            <div>
                                <pre id="gemini-response-text" class="bg-gray-100 p-4 rounded-md whitespace-pre-wrap font-sans text-sm">${text}</pre>
                                <button id="gemini-copy-btn" class="mt-4 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 flex items-center">
                                    <i data-lucide="copy" class="mr-2" style="width:16px; height:16px;"></i> Copiar
                                </button>
                            </div>`;
                        openGeminiModal(title, contentHTML);
                    } else {
                        throw new Error("No se recibió contenido de la API.");
                    }
                } catch (err) {
                    console.error("Error calling Gemini API:", err);
                    openGeminiModal("Error", `<p class="text-red-500">${err.message}</p>`);
                } finally {
                    lucide.createIcons();
                }
            };

            // --- VIEW RENDERING FUNCTIONS ---
            let dashboardCharts = {};
            let salesKpiCharts = {};
            let servicesKpiCharts = {};

            const renderDashboard = () => {
                const { clients, gpsDevices, personnel, sims } = state;
                const activos = clients.filter(c => c.status === 'activo').length;
                const suspendidos = clients.filter(c => c.status === 'suspendido').length;
                const atrasados = clients.filter(c => c.paymentStatus === 'atrasado').length;
                const clientChartData = {
                    labels: ['Activos', 'Suspendidos', 'Pago Atrasado'],
                    datasets: [{
                        data: [activos, suspendidos, atrasados],
                        backgroundColor: ['#10B981', '#F97316', '#F59E0B'],
                        hoverOffset: 4
                    }]
                };
                const gpsStatusCounts = gpsDevices.reduce((acc, device) => {
                    const status = device.status || 'almacen';
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, { baja: 0, almacen: 0, instalado: 0, laboratorio: 0, senuelo: 0, cita_instalacion: 0 });
                
                const simCardCount = sims.length;

                const accessoryStockData = gpsDevices.reduce((acc, device) => {
                    if (device.status === 'almacen' && device.accessories) {
                        if (device.accessories.sos) acc.sos++;
                        if (device.accessories.relay) acc.relay++;
                        if (device.accessories.mic) acc.microfono++;
                        if (device.accessories.fuel) acc.fuel++;
                        if (device.accessories.temp) acc.temp++;
                        if (device.accessories.camera) acc.camera++;
                    }
                    return acc;
                }, { sos: 0, relay: 0, microfono: 0, fuel: 0, temp: 0, camera: 0 });
                const teamData = personnel.reduce((acc, p) => {
                        if (p.isVendedor) acc.vendedores++;
                        if (p.isTecnico) acc.tecnicos++;
                        if (p.type === 'activo') acc.activos++;
                        if (p.type === 'externo') acc.externos++;
                        return acc;
                }, { vendedores: 0, tecnicos: 0, activos: 0, externos: 0 });
                const html = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard General</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Estado de Clientes</h3>
                            <div style="width:100%; height: 250px;">
                                <canvas id="client-chart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md flex flex-col justify-center">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Resumen de Clientes</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Activos</span><span class="font-bold text-lg text-green-600">${activos}</span></div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Suspendidos</span><span class="font-bold text-lg text-orange-600">${suspendidos}</span></div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Pago Atrasado</span><span class="font-bold text-lg text-amber-600">${atrasados}</span></div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md flex flex-col justify-center">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Team Skytrix</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Colaboradores Activos</span><span class="font-bold text-lg text-green-600">${teamData.activos}</span></div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Colaboradores Externos</span><span class="font-bold text-lg text-yellow-600">${teamData.externos}</span></div>
                                 <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md border-t mt-3 pt-3"><span class="font-medium text-gray-600">Total Vendedores</span><span class="font-bold text-lg text-indigo-600">${teamData.vendedores}</span></div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="font-medium text-gray-600">Total Técnicos</span><span class="font-bold text-lg text-slate-600">${teamData.tecnicos}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Resumen de Equipos Skytrix</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 text-center mb-6">
                            <div class="p-4 bg-blue-50 rounded-lg"><div class="text-3xl font-bold text-blue-700">${gpsStatusCounts.almacen}</div><div class="text-sm font-medium text-blue-600 mt-1">Almacén</div></div>
                            <div class="p-4 bg-teal-50 rounded-lg"><div class="text-3xl font-bold text-teal-700">${gpsStatusCounts.cita_instalacion}</div><div class="text-sm font-medium text-teal-600 mt-1">En Cita</div></div>
                            <div class="p-4 bg-green-50 rounded-lg"><div class="text-3xl font-bold text-green-700">${gpsStatusCounts.instalado}</div><div class="text-sm font-medium text-green-600 mt-1">Instalado</div></div>
                            <div class="p-4 bg-purple-50 rounded-lg"><div class="text-3xl font-bold text-purple-700">${gpsStatusCounts.laboratorio}</div><div class="text-sm font-medium text-purple-600 mt-1">Laboratorio</div></div>
                            <div class="p-4 bg-yellow-50 rounded-lg"><div class="text-3xl font-bold text-yellow-700">${gpsStatusCounts.senuelo}</div><div class="text-sm font-medium text-yellow-600 mt-1">Señuelo</div></div>
                            <div class="p-4 bg-red-50 rounded-lg"><div class="text-3xl font-bold text-red-700">${gpsStatusCounts.baja}</div><div class="text-sm font-medium text-red-600 mt-1">Baja</div></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center border-t pt-6">Inventario de Accesorios en Almacén</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4 text-center">
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${simCardCount}</span><span class="text-sm text-gray-600 ml-2">Tarjetas SIM</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.relay}</span><span class="text-sm text-gray-600 ml-2">Relay</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.sos}</span><span class="text-sm text-gray-600 ml-2">Botón SOS</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.microfono}</span><span class="text-sm text-gray-600 ml-2">Micrófono</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.fuel}</span><span class="text-sm text-gray-600 ml-2">Sensor Comb.</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.temp}</span><span class="text-sm text-gray-600 ml-2">Sensor Temp.</span></div>
                            <div class="p-3 bg-gray-100 rounded-lg"><span class="font-bold text-gray-700">${accessoryStockData.camera}</span><span class="text-sm text-gray-600 ml-2">Cámara</span></div>
                        </div>
                    </div>`;
                document.getElementById('view-dashboard').innerHTML = html;
                const ctx = document.getElementById('client-chart').getContext('2d');
                if (dashboardCharts.clientChart) {
                    dashboardCharts.clientChart.destroy();
                }
                dashboardCharts.clientChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: clientChartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) { label += context.parsed + ' Clientes'; }
                                        return label;
                                    }
                                }
                            }
                        }
                    },
                });
            };

            const renderKpisVentas = () => {
                const salesReps = state.personnel.filter(p => p.isVendedor);
                const salesRepOptions = salesReps.map(s => `<option value="${s.id}" ${state.kpiPersonnelFilter === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

                // Determine date range
                let startDate, endDate;
                const now = new Date();
                switch (state.kpiPeriodFilter) {
                    case 'day':
                        startDate = new Date(state.kpiDateFilter);
                        startDate.setUTCHours(0, 0, 0, 0);
                        endDate = new Date(state.kpiDateFilter);
                        endDate.setUTCHours(23, 59, 59, 999);
                        break;
                    case 'week':
                        const [yearW, weekN] = state.kpiDateFilter.split('-W');
                        const firstDayOfYear = new Date(yearW, 0, 1);
                        const days = (weekN - 1) * 7;
                        startDate = new Date(firstDayOfYear.setDate(firstDayOfYear.getDate() + days));
                        startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'month':
                        const [yearM, monthM] = state.kpiDateFilter.split('-');
                        startDate = new Date(yearM, monthM - 1, 1);
                        endDate = new Date(yearM, monthM, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'year':
                        startDate = new Date(state.kpiDateFilter, 0, 1);
                        endDate = new Date(state.kpiDateFilter, 11, 31);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }

                const filteredSalesByRep = state.kpiPersonnelFilter === 'all'
                    ? state.sales
                    : state.sales.filter(s => s.salesRepId === state.kpiPersonnelFilter);
                
                const filteredSales = filteredSalesByRep.filter(s => {
                    const saleDate = new Date(s.saleDate);
                    return saleDate >= startDate && saleDate <= endDate;
                });

                const totalSales = filteredSales.reduce((sum, s) => sum + s.totalCost, 0);
                const salesCount = filteredSales.length;
                const averageSale = salesCount > 0 ? totalSales / salesCount : 0;

                const html = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">KPIs de Ventas</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="kpi-period-filter" class="block text-sm font-medium text-gray-700">Periodo</label>
                                <select id="kpi-period-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="day" ${state.kpiPeriodFilter === 'day' ? 'selected' : ''}>Día</option>
                                    <option value="week" ${state.kpiPeriodFilter === 'week' ? 'selected' : ''}>Semana</option>
                                    <option value="month" ${state.kpiPeriodFilter === 'month' ? 'selected' : ''}>Mes</option>
                                    <option value="year" ${state.kpiPeriodFilter === 'year' ? 'selected' : ''}>Año</option>
                                </select>
                            </div>
                            <div id="kpi-date-filter-container">
                                <!-- Dynamic date filter input will be rendered here -->
                            </div>
                            <div>
                                <label for="kpi-personnel-filter" class="block text-sm font-medium text-gray-700">Vendedor</label>
                                <select id="kpi-personnel-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="all" ${state.kpiPersonnelFilter === 'all' ? 'selected' : ''}>Todos los Vendedores</option>
                                    ${salesRepOptions}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Ventas Totales</h3>
                            <p class="text-3xl font-bold text-blue-600 mt-2">${formatCurrency(totalSales)}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Número de Ventas</h3>
                            <p class="text-3xl font-bold text-green-600 mt-2">${salesCount}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Promedio por Venta</h3>
                            <p class="text-3xl font-bold text-purple-600 mt-2">${formatCurrency(averageSale)}</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-lg font-semibold text-gray-700 mb-4">Gráfica de Rendimiento</h3>
                         <canvas id="sales-performance-chart"></canvas>
                    </div>
                `;
                document.getElementById('view-kpis-ventas').innerHTML = html;
                updateDateFilterUI('kpi');
                renderSalesCharts(filteredSales, startDate, endDate);
            };

            const renderKpisServicios = () => {
                const technicians = state.personnel.filter(p => p.isTecnico);
                const techOptions = technicians.map(t => `<option value="${t.id}" ${state.kpiTechnicianFilter === t.id ? 'selected' : ''}>${t.name}</option>`).join('');

                // Determine date range
                let startDate, endDate;
                const now = new Date();
                switch (state.kpiPeriodFilter) {
                    case 'day':
                        startDate = new Date(state.kpiDateFilter);
                        startDate.setUTCHours(0, 0, 0, 0);
                        endDate = new Date(state.kpiDateFilter);
                        endDate.setUTCHours(23, 59, 59, 999);
                        break;
                    case 'week':
                        const [yearW, weekN] = state.kpiDateFilter.split('-W');
                        const firstDayOfYear = new Date(yearW, 0, 1);
                        const days = (weekN - 1) * 7;
                        startDate = new Date(firstDayOfYear.setDate(firstDayOfYear.getDate() + days));
                        startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'month':
                        const [yearM, monthM] = state.kpiDateFilter.split('-');
                        startDate = new Date(yearM, monthM - 1, 1);
                        endDate = new Date(yearM, monthM, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'year':
                        startDate = new Date(state.kpiDateFilter, 0, 1);
                        endDate = new Date(state.kpiDateFilter, 11, 31);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                }

                const filteredByDate = state.serviciosSkytrix.filter(s => {
                    const serviceDate = new Date(s.fecha);
                    return serviceDate >= startDate && serviceDate <= endDate;
                });

                const filteredByTech = state.kpiTechnicianFilter === 'all'
                    ? filteredByDate
                    : filteredByDate.filter(s => s.technicianId === state.kpiTechnicianFilter);

                const filteredServices = state.kpiServiceTypeFilter === 'all'
                    ? filteredByTech
                    : filteredByTech.filter(s => s.tipoServicio === state.kpiServiceTypeFilter);

                const totalServices = filteredServices.length;
                const installations = filteredServices.filter(s => s.tipoServicio === 'Instalación').length;
                const services = filteredServices.filter(s => s.tipoServicio === 'Servicio').length;
                const deinstallations = filteredServices.filter(s => s.tipoServicio === 'Desinstalación').length;

                const html = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">KPIs de Servicios</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="kpi-period-filter" class="block text-sm font-medium text-gray-700">Periodo</label>
                                <select id="kpi-period-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="day" ${state.kpiPeriodFilter === 'day' ? 'selected' : ''}>Día</option>
                                    <option value="week" ${state.kpiPeriodFilter === 'week' ? 'selected' : ''}>Semana</option>
                                    <option value="month" ${state.kpiPeriodFilter === 'month' ? 'selected' : ''}>Mes</option>
                                    <option value="year" ${state.kpiPeriodFilter === 'year' ? 'selected' : ''}>Año</option>
                                </select>
                            </div>
                            <div id="kpi-date-filter-container">
                                <!-- Dynamic date filter input will be rendered here -->
                            </div>
                            <div>
                                <label for="kpi-technician-filter" class="block text-sm font-medium text-gray-700">Técnico</label>
                                <select id="kpi-technician-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="all" ${state.kpiTechnicianFilter === 'all' ? 'selected' : ''}>Todos los Técnicos</option>
                                    ${techOptions}
                                </select>
                            </div>
                            <div>
                                <label for="kpi-service-type-filter" class="block text-sm font-medium text-gray-700">Tipo de Servicio</label>
                                <select id="kpi-service-type-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="all" ${state.kpiServiceTypeFilter === 'all' ? 'selected' : ''}>Todos</option>
                                    <option value="Instalación" ${state.kpiServiceTypeFilter === 'Instalación' ? 'selected' : ''}>Instalación</option>
                                    <option value="Servicio" ${state.kpiServiceTypeFilter === 'Servicio' ? 'selected' : ''}>Servicio</option>
                                    <option value="Desinstalación" ${state.kpiServiceTypeFilter === 'Desinstalación' ? 'selected' : ''}>Desinstalación</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Total Servicios</h3>
                            <p class="text-3xl font-bold text-blue-600 mt-2">${totalServices}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Instalaciones</h3>
                            <p class="text-3xl font-bold text-green-600 mt-2">${installations}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Servicios</h3>
                            <p class="text-3xl font-bold text-yellow-600 mt-2">${services}</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <h3 class="text-lg font-semibold text-gray-700">Desinstalaciones</h3>
                            <p class="text-3xl font-bold text-red-600 mt-2">${deinstallations}</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-lg font-semibold text-gray-700 mb-4">Rendimiento de Servicios</h3>
                         <canvas id="services-performance-chart"></canvas>
                    </div>
                `;
                document.getElementById('view-kpis-servicios').innerHTML = html;
                updateDateFilterUI('kpi');
                renderServiciosCharts(filteredServices, startDate, endDate);
            };

            const renderComisiones = () => {
                let html = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Cálculo de Comisiones</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                             <div>
                                <label for="commission-type-filter" class="block text-sm font-medium text-gray-700">Tipo de Personal</label>
                                <select id="commission-type-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="vendedores" ${state.commissionTypeFilter === 'vendedores' ? 'selected' : ''}>Vendedores</option>
                                    <option value="tecnicos" ${state.commissionTypeFilter === 'tecnicos' ? 'selected' : ''}>Técnicos</option>
                                </select>
                            </div>
                            <div>
                                <label for="kpi-period-filter" class="block text-sm font-medium text-gray-700">Periodo</label>
                                <select id="kpi-period-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="day" ${state.kpiPeriodFilter === 'day' ? 'selected' : ''}>Día</option>
                                    <option value="week" ${state.kpiPeriodFilter === 'week' ? 'selected' : ''}>Semana</option>
                                    <option value="month" ${state.kpiPeriodFilter === 'month' ? 'selected' : ''}>Mes</option>
                                    <option value="year" ${state.kpiPeriodFilter === 'year' ? 'selected' : ''}>Año</option>
                                </select>
                            </div>
                            <div id="kpi-date-filter-container">
                                <!-- Dynamic date filter input will be rendered here -->
                            </div>
                            <div id="kpi-personnel-filter-container">
                                <!-- Dynamic personnel filter will be rendered here -->
                            </div>
                        </div>
                    </div>
                    <div id="commission-kpi-cards"></div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h3 class="text-lg font-semibold text-gray-700 mb-4">Gráfica de Comisiones</h3>
                         <canvas id="commission-performance-chart"></canvas>
                    </div>
                `;
                document.getElementById('view-comisiones').innerHTML = html;
                updateDateFilterUI('kpi');
                updateCommissionView();
            };

            const updateCommissionView = () => {
                const { commissionTypeFilter, kpiPersonnelFilter, kpiPeriodFilter, kpiDateFilter, personnel, sales, serviciosSkytrix } = state;
                
                const personnelContainer = document.getElementById('kpi-personnel-filter-container');
                const kpiCardsContainer = document.getElementById('commission-kpi-cards');

                let options = '';
                let label = '';

                if (commissionTypeFilter === 'vendedores') {
                    label = 'Vendedor';
                    const salesReps = personnel.filter(p => p.isVendedor);
                    options = salesReps.map(s => `<option value="${s.id}" ${kpiPersonnelFilter === s.id ? 'selected' : ''}>${s.name}</option>`).join('');
                } else {
                    label = 'Técnico';
                    const technicians = personnel.filter(p => p.isTecnico);
                    options = technicians.map(t => `<option value="${t.id}" ${kpiPersonnelFilter === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
                }

                personnelContainer.innerHTML = `
                    <label for="kpi-personnel-filter" class="block text-sm font-medium text-gray-700">${label}</label>
                    <select id="kpi-personnel-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="all">Todos los ${label}es</option>
                        ${options}
                    </select>
                `;

                // Determine date range
                let startDate, endDate;
                const now = new Date();
                switch (kpiPeriodFilter) {
                    case 'day': startDate = new Date(kpiDateFilter); startDate.setUTCHours(0, 0, 0, 0); endDate = new Date(kpiDateFilter); endDate.setUTCHours(23, 59, 59, 999); break;
                    case 'week': const [yearW, weekN] = kpiDateFilter.split('-W'); const firstDayOfYearW = new Date(yearW, 0, 1); const daysW = (weekN - 1) * 7; startDate = new Date(firstDayOfYearW.setDate(firstDayOfYearW.getDate() + daysW)); startDate.setDate(startDate.getDate() - startDate.getDay() + 1); endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
                    case 'month': const [yearM, monthM] = kpiDateFilter.split('-'); startDate = new Date(yearM, monthM - 1, 1); endDate = new Date(yearM, monthM, 0); endDate.setHours(23, 59, 59, 999); break;
                    case 'year': startDate = new Date(kpiDateFilter, 0, 1); endDate = new Date(kpiDateFilter, 11, 31); endDate.setHours(23, 59, 59, 999); break;
                }

                if (commissionTypeFilter === 'vendedores') {
                    const salesWithCommissions = sales.map(sale => ({ ...sale, commission: COMMISSION_RATES_SALES[sale.packageType] || 0 }));
                    const filteredByRep = kpiPersonnelFilter === 'all' ? salesWithCommissions : salesWithCommissions.filter(s => s.salesRepId === kpiPersonnelFilter);
                    const filteredSales = filteredByRep.filter(s => { const saleDate = new Date(s.saleDate); return saleDate >= startDate && saleDate <= endDate; });
                    
                    const totalCommissions = filteredSales.reduce((sum, s) => sum + s.commission, 0);
                    const salesCount = filteredSales.length;
                    const averageCommission = salesCount > 0 ? totalCommissions / salesCount : 0;

                    kpiCardsContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Comisiones Ventas Totales</h3><p class="text-3xl font-bold text-blue-600 mt-2">${formatCurrency(totalCommissions)}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Número de Ventas</h3><p class="text-3xl font-bold text-green-600 mt-2">${salesCount}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Comisión Promedio</h3><p class="text-3xl font-bold text-purple-600 mt-2">${formatCurrency(averageCommission)}</p></div>
                        </div>
                    `;
                    renderCommissionCharts(filteredSales, startDate, endDate, 'commission');
                } else { // tecnicos
                    const servicesWithCommissions = serviciosSkytrix.map(service => ({ ...service, commission: service.tipoServicio === 'Instalación' ? (COMMISSION_RATES_SERVICES[service.packageType] || 0) : 0 }));
                    const filteredByTech = kpiPersonnelFilter === 'all' ? servicesWithCommissions : servicesWithCommissions.filter(s => s.technicianId === kpiPersonnelFilter);
                    const filteredServices = filteredByTech.filter(s => { const serviceDate = new Date(s.fecha); return serviceDate >= startDate && serviceDate <= endDate; });

                    const totalCommissions = filteredServices.reduce((sum, s) => sum + s.commission, 0);
                    const servicesCount = filteredServices.length;
                    const averageCommission = servicesCount > 0 ? totalCommissions / servicesCount : 0;

                    kpiCardsContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Comisiones Servicios Totales</h3><p class="text-3xl font-bold text-blue-600 mt-2">${formatCurrency(totalCommissions)}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Número de Servicios</h3><p class="text-3xl font-bold text-green-600 mt-2">${servicesCount}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-700">Comisión Servicio Promedio</h3><p class="text-3xl font-bold text-purple-600 mt-2">${formatCurrency(averageCommission)}</p></div>
                        </div>
                    `;
                    renderCommissionCharts(filteredServices, startDate, endDate, 'commission');
                }
            };

            const updateDateFilterUI = (prefix) => {
                const container = document.getElementById(`${prefix}-date-filter-container`);
                if (!container) return;
                let inputHtml = '';
                let label = 'Seleccionar';
                switch (state.kpiPeriodFilter) {
                    case 'day':
                        label = 'Día';
                        inputHtml = `<input type="date" id="${prefix}-date-input" value="${state.kpiDateFilter}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">`;
                        break;
                    case 'week':
                        label = 'Semana';
                        inputHtml = `<input type="week" id="${prefix}-date-input" value="${state.kpiDateFilter}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">`;
                        break;
                    case 'month':
                        label = 'Mes';
                        inputHtml = `<input type="month" id="${prefix}-date-input" value="${state.kpiDateFilter}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">`;
                        break;
                    case 'year':
                        label = 'Año';
                        const currentYear = new Date().getFullYear();
                        let yearOptions = '';
                        for (let y = currentYear; y >= 2020; y--) {
                            yearOptions += `<option value="${y}" ${state.kpiDateFilter == y ? 'selected' : ''}>${y}</option>`;
                        }
                        inputHtml = `<select id="${prefix}-date-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">${yearOptions}</select>`;
                        break;
                }
                container.innerHTML = `<label for="${prefix}-date-input" class="block text-sm font-medium text-gray-700">${label}</label>${inputHtml}`;
            };


            const renderSalesCharts = (salesData, startDate, endDate) => {
                let labels = [];
                let data = [];
                const chartCtx = document.getElementById('sales-performance-chart')?.getContext('2d');
                if (!chartCtx) return;
                if (salesKpiCharts.performanceChart) salesKpiCharts.performanceChart.destroy();

                if (state.kpiPeriodFilter === 'year') {
                    // Monthly breakdown
                    labels = Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('es-ES', { month: 'short' }));
                    data = Array(12).fill(0);
                    salesData.forEach(sale => {
                        const month = new Date(sale.saleDate).getMonth();
                        data[month] += sale.totalCost;
                    });
                } else {
                    // Daily breakdown
                    const daysInRange = (end, start) => (end - start) / (1000 * 60 * 60 * 24);
                    if (daysInRange(endDate, startDate) > 40) return; // Avoid overly large charts

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        labels.push(d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
                    }
                    data = Array(labels.length).fill(0);
                    salesData.forEach(sale => {
                        const saleDate = new Date(sale.saleDate);
                        const diffDays = Math.floor((saleDate - startDate) / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays < data.length) {
                            data[diffDays] += sale.totalCost;
                        }
                    });
                }
                
                salesKpiCharts.performanceChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ventas',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            };

            const renderCommissionCharts = (chartData, startDate, endDate, dataKey) => {
                let labels = [];
                let data = [];
                const chartCtx = document.getElementById('commission-performance-chart')?.getContext('2d');
                if (!chartCtx) return;
                if (salesKpiCharts.commissionChart) salesKpiCharts.commissionChart.destroy();

                const dateField = state.commissionTypeFilter === 'vendedores' ? 'saleDate' : 'fecha';

                if (state.kpiPeriodFilter === 'year') {
                    labels = Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('es-ES', { month: 'short' }));
                    data = Array(12).fill(0);
                    chartData.forEach(item => {
                        const month = new Date(item[dateField]).getMonth();
                        data[month] += item[dataKey];
                    });
                } else {
                    const daysInRange = (end, start) => (end - start) / (1000 * 60 * 60 * 24);
                    if (daysInRange(endDate, startDate) > 40) return;

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        labels.push(d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
                    }
                    data = Array(labels.length).fill(0);
                    chartData.forEach(item => {
                        const itemDate = new Date(item[dateField]);
                        const diffDays = Math.floor((itemDate - startDate) / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays < data.length) {
                            data[diffDays] += item[dataKey];
                        }
                    });
                }
                
                salesKpiCharts.commissionChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Comisiones',
                            data: data,
                            backgroundColor: 'rgba(14, 165, 233, 0.6)',
                            borderColor: 'rgba(14, 165, 233, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            };

            const renderServiciosCharts = (servicesData, startDate, endDate) => {
                let labels = [];
                let data = [];
                const chartCtx = document.getElementById('services-performance-chart')?.getContext('2d');
                if (!chartCtx) return;
                if (servicesKpiCharts.performanceChart) servicesKpiCharts.performanceChart.destroy();

                if (state.kpiPeriodFilter === 'year') {
                    // Monthly breakdown
                    labels = Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('es-ES', { month: 'short' }));
                    data = Array(12).fill(0);
                    servicesData.forEach(service => {
                        const month = new Date(service.fecha).getMonth();
                        data[month]++;
                    });
                } else {
                    // Daily breakdown
                    const daysInRange = (end, start) => (end - start) / (1000 * 60 * 60 * 24);
                    if (daysInRange(endDate, startDate) > 40) return; // Avoid overly large charts

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        labels.push(d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
                    }
                    data = Array(labels.length).fill(0);
                    servicesData.forEach(service => {
                        const serviceDate = new Date(service.fecha);
                        const diffDays = Math.floor((serviceDate - startDate) / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays < data.length) {
                            data[diffDays]++;
                        }
                    });
                }
                
                servicesKpiCharts.performanceChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Servicios Realizados',
                            data: data,
                            backgroundColor: 'rgba(139, 92, 246, 0.6)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            };

            const renderGps = () => {
                const { gpsDevices } = state;
                const listHtml = gpsDevices.length > 0 ? gpsDevices.map(gps => {
                    const vehicle = state.vehicles.find(v => v.id === gps.vehicleId);
                    const vehicleInfo = vehicle ? `${vehicle.make || ''} ${vehicle.model || ''} (${vehicle.plate || ''})` : 'N/A';
                    return `
                    <tr key="${gps.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${gps.deviceId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gps.model}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gps.imeiGps || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gps.lineaSim || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gps.imeiSim || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${locationBadge(gps.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gps.clientName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${vehicleInfo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                            <button class="edit-gps-btn text-indigo-600 hover:text-indigo-900" data-id="${gps.id}" title="Editar"><i data-lucide="edit" style="width:18px; height:18px;"></i></button>
                            <button class="delete-gps-btn text-red-600 hover:text-red-900" data-id="${gps.id}" title="Eliminar"><i data-lucide="trash-2" style="width:18px; height:18px;"></i></button>
                        </td>
                    </tr>
                    `}).join('') : `<tr><td colspan="9" class="text-center text-gray-500 py-4">No hay equipos GPS registrados.</td></tr>`;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Gestión de Equipos GPS</h2>
                            <button id="add-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nuevo Equipo
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Equipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo GPS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IMEI GPS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Línea SIM</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IMEI SIM</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localización</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('view-gps').innerHTML = html;
                lucide.createIcons();
            };
            
            const renderGpsForm = (gps = null) => {
                const { clients, vehicles, personnel } = state;
                const technicians = personnel.filter(p => p.isTecnico);
                const clientOptions = clients.map(c => `<option value="${c.id}" ${gps?.clientId === c.id ? 'selected' : ''}>${c.company || c.name}</option>`).join('');
                const vehicleOptions = (gps?.clientId ? vehicles.filter(v => v.clientId === gps.clientId) : []).map(v => `<option value="${v.id}" ${gps?.vehicleId === v.id ? 'selected' : ''}>${v.make} ${v.model} (${v.plate})</option>`).join('');
                const techOptions = technicians.map(t => `<option value="${t.id}" ${gps?.technicianId === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
                const personnelOptions = personnel.map(p => `<option value="${p.id}" ${gps?.assignedToId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                const accessories = gps?.accessories || { sos: false, relay: false, mic: false, fuel: false, temp: false, camera: false };
                
                const formHtml = `
                    <form id="gps-form" data-id="${gps?.id || ''}" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ID del Equipo</label>
                                <input type="text" name="deviceId" value="${gps?.deviceId || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Modelo GPS</label>
                                <input type="text" name="model" value="${gps?.model || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">IMEI GPS</label>
                                <input type="text" name="imeiGps" value="${gps?.imeiGps || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Password GPS</label>
                                <input type="text" name="passwordGps" value="${gps?.passwordGps || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Línea Telefónica SIM</label>
                                <input type="text" name="lineaSim" value="${gps?.lineaSim || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">IMEI Tarjeta SIM</label>
                                <input type="text" name="imeiSim" value="${gps?.imeiSim || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100" readonly/>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Paquete Skytrix GPS</label>
                            <select name="paquete" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="">Seleccionar Paquete</option>
                                <option value="Skytrix for Family" ${gps?.paquete === 'Skytrix for Family' ? 'selected' : ''}>Skytrix for Family</option>
                                <option value="Skytrix for Fleet" ${gps?.paquete === 'Skytrix for Fleet' ? 'selected' : ''}>Skytrix for Fleet</option>
                                <option value="Skytrix for Pets" ${gps?.paquete === 'Skytrix for Pets' ? 'selected' : ''}>Skytrix for Pets</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Accesorios Incluidos</label>
                            <div class="mt-2 grid grid-cols-2 gap-2 border p-3 rounded-md">
                                <label class="flex items-center"><input type="checkbox" name="sos" ${accessories.sos ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Botón SOS</span></label>
                                <label class="flex items-center"><input type="checkbox" name="relay" ${accessories.relay ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Relay</span></label>
                                <label class="flex items-center"><input type="checkbox" name="mic" ${accessories.mic ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Micrófono</span></label>
                                <label class="flex items-center"><input type="checkbox" name="fuel" ${accessories.fuel ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Sensor Comb.</span></label>
                                <label class="flex items-center"><input type="checkbox" name="temp" ${accessories.temp ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Sensor Temp.</span></label>
                                <label class="flex items-center"><input type="checkbox" name="camera" ${accessories.camera ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300"> <span class="ml-2">Cámara</span></label>
                            </div>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="isSenuelo" ${gps?.isSenuelo ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/>
                                <span class="ml-3 text-sm font-medium text-gray-800">Este equipo es un señuelo (decoy)</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Estado / Localización</label>
                            <select name="status" id="gps-status-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="almacen" ${gps?.status === 'almacen' ? 'selected' : ''}>Almacén</option>
                                <option value="cita_instalacion" ${gps?.status === 'cita_instalacion' ? 'selected' : ''}>Cita de Instalación</option>
                                <option value="instalado" ${gps?.status === 'instalado' ? 'selected' : ''}>Instalado</option>
                                <option value="laboratorio" ${gps?.status === 'laboratorio' ? 'selected' : ''}>Laboratorio</option>
                                <option value="senuelo" ${gps?.status === 'senuelo' ? 'selected' : ''}>Señuelo</option>
                                <option value="baja" ${gps?.status === 'baja' ? 'selected' : ''}>Baja</option>
                            </select>
                        </div>
                        <div id="inventory-fields" class="border-t pt-4 mt-4 space-y-4">
                            <h4 class="text-md font-semibold text-gray-800">Ubicación del Equipo</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Asignado a</label>
                                <select name="assignedToId" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="">Almacén Skytrix</option>
                                    ${personnelOptions}
                                </select>
                            </div>
                        </div>
                        <div id="installation-fields" class="hidden">
                             <div class="border-t pt-4 mt-4 space-y-4">
                                <h4 class="text-md font-semibold text-gray-800">Detalles de Instalación</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">1. Cliente</label>
                                    <select name="clientId" id="gps-form-client-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option value="">Seleccionar</option>${clientOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">2. Vehículo</label>
                                    <select name="vehicleId" id="gps-form-vehicle-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option value="">Seleccionar</option>${vehicleOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Técnico Instalador</label>
                                    <select name="technicianId" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option value="">Seleccionar</option>${techOptions}</select>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700">Fecha de Instalación</label>
                                    <input type="date" name="installationDate" value="${gps?.installationDate || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                                </div>
                                 <button type="button" id="generate-checklist-btn" class="w-full bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 flex items-center justify-center">
                                    <i data-lucide="sparkles" class="mr-2" style="width:18px; height:18px;"></i> Generar Checklist
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-gps-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                        </div>
                    </form>
                `;
                openModal(gps ? "Editar Equipo GPS" : "Nuevo Equipo GPS", formHtml);
                lucide.createIcons();
                
                const senueloCheckbox = document.querySelector('input[name="isSenuelo"]');
                const statusSelect = document.getElementById('gps-status-select');
                if (senueloCheckbox && statusSelect) {
                    const syncSenueloState = () => {
                        senueloCheckbox.checked = statusSelect.value === 'senuelo';
                    };

                    senueloCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            statusSelect.value = 'senuelo';
                        } else {
                            if (statusSelect.value === 'senuelo') {
                                statusSelect.value = 'almacen';
                            }
                        }
                        statusSelect.dispatchEvent(new Event('change'));
                    });

                    statusSelect.addEventListener('change', syncSenueloState);
                    syncSenueloState(); // Initial sync
                }

                document.getElementById('gps-status-select').dispatchEvent(new Event('change'));
            };

            const renderClients = () => {
                const { clients } = state;
                const listHtml = clients.length > 0 ? clients.map(client => `
                    <tr key="${client.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.company || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.micodusUser || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statusBadge(client.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${paymentBadge(client.paymentStatus)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button class="edit-client-btn text-indigo-600 hover:text-indigo-900" data-id="${client.id}"><i data-lucide="edit" style="width:18px; height:18px;"></i></button>
                            ${client.paymentStatus === 'atrasado' ? `<button class="remind-client-btn text-amber-600 hover:text-amber-900" data-id="${client.id}" title="Generar Recordatorio"><i data-lucide="sparkles" style="width:18px; height:18px;"></i></button>` : ''}
                        </td>
                    </tr>
                `).join('') : `<tr><td colspan="7" class="text-center text-gray-500 py-4">No hay clientes registrados.</td></tr>`;
                const html = `
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-xl font-bold text-gray-800">Gestión de Clientes</h2>
                                        <button id="add-client-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                                            <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nuevo Cliente
                                        </button>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full bg-white divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario Micodus</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuenta</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                                        </table>
                                    </div>
                                </div>`;
                document.getElementById('view-clients').innerHTML = html;
                lucide.createIcons();
            };
            
            const renderClientForm = (client = null) => {
                const stateOptions = mexicanStates.map(s => `<option value="${s}" ${client?.estado === s ? 'selected' : ''}>${s}</option>`).join('');
                const formHtml = `
                    <form id="client-form" data-id="${client?.id || ''}" class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900">Información de Contacto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="name" placeholder="Nombre del Cliente" value="${client?.name || ''}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="company" placeholder="Empresa" value="${client?.company || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="tel" name="phone" placeholder="Teléfono" value="${client?.phone || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="email" name="email" placeholder="Email" value="${client?.email || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Usuario en Micodus</label>
                            <input type="text" name="micodusUser" placeholder="Usuario en Micodus" value="${client?.micodusUser || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 pt-4 border-t mt-4">Dirección</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><input type="text" name="address" placeholder="Calle y Número" value="${client?.address || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/></div>
                            <input type="text" name="colonia" placeholder="Colonia" value="${client?.colonia || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="codigoPostal" placeholder="Código Postal" value="${client?.codigoPostal || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="municipio" placeholder="Municipio" value="${client?.municipio || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <select name="estado" class="mt-1 block w-full border-gray-300 rounded-md"><option value="">Seleccionar Estado</option>${stateOptions}</select>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 pt-4 border-t mt-4">Datos de Facturación</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Plan de Pago</label>
                                <select name="planDePago" class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="Mensual" ${client?.planDePago === 'Mensual' ? 'selected' : ''}>Mensual</option>
                                    <option value="Anual" ${client?.planDePago === 'Anual' ? 'selected' : ''}>Anual</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Día de Corte</label>
                                <input type="number" name="fechaDeCorte" placeholder="1-31" value="${client?.fechaDeCorte || ''}" min="1" max="31" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Inicio de Servicio</label>
                                <input type="date" name="fechaDeInicioServicio" value="${client?.fechaDeInicioServicio || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            </div>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 pt-4 border-t mt-4">Estado del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                 <label class="text-sm">Estado del Cliente</label>
                                 <select name="status" class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="activo" ${client?.status === 'activo' ? 'selected' : ''}>Activo</option>
                                    <option value="suspendido" ${client?.status === 'suspendido' ? 'selected' : ''}>Suspendido</option>
                                </select>
                            </div>
                             <div>
                                 <label class="text-sm">Estado de Cuenta</label>
                                 <select name="paymentStatus" class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="al_corriente" ${client?.paymentStatus === 'al_corriente' ? 'selected' : ''}>Al Corriente</option>
                                    <option value="atrasado" ${client?.paymentStatus === 'atrasado' ? 'selected' : ''}>Atrasado</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-client-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg">Guardar Cliente</button>
                        </div>
                    </form>
                `;
                openModal(client ? "Editar Cliente" : "Nuevo Cliente", formHtml);
            };

            const renderVehicles = () => {
                const { vehicles, gpsDevices } = state;
                const listHtml = vehicles.length > 0 ? vehicles.map(v => {
                    const associatedGps = gpsDevices.find(gps => gps.vehicleId === v.id);
                    const lineaSim = associatedGps ? associatedGps.lineaSim || 'N/A' : 'N/A';
                    const deviceId = associatedGps ? associatedGps.deviceId || 'N/A' : 'N/A';
                    return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${v.nickname || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lineaSim}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${deviceId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatVehicleType(v.vehicleType)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${v.vin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${v.plate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${v.make} ${v.model} ${v.year}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${v.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-vehicle-btn text-indigo-600 hover:text-indigo-900" data-id="${v.id}"><i data-lucide="edit" style="width:18px; height:18px;"></i></button>
                        </td>
                    </tr>
                `}).join('') : `<tr><td colspan="9" class="text-center text-gray-500 py-4">No hay vehículos registrados.</td></tr>`;
                
                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Gestión de Vehículos</h2>
                            <button id="add-vehicle-btn" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 flex items-center">
                                <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nuevo Vehículo
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nickname</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Línea SIM</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Equipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VIN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('view-vehicles').innerHTML = html;
                lucide.createIcons();
            };

            const renderVehicleForm = (vehicle = null) => {
                const clientOptions = state.clients.map(c => `<option value="${c.id}" ${vehicle?.clientId === c.id ? 'selected' : ''}>${c.company || c.name}</option>`).join('');
                const formHtml = `
                    <form id="vehicle-form" data-id="${vehicle?.id || ''}" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tipo de Vehículo</label>
                                <select name="vehicleType" required class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="" disabled ${!vehicle ? 'selected' : ''}>-- Seleccione una categoría --</option>
                                    <optgroup label="Motocicletas y Similares">
                                        <option value="motocicleta" ${vehicle?.vehicleType === 'motocicleta' ? 'selected' : ''}>Motocicleta / Motoneta</option>
                                        <option value="triciclo_cuatrimoto" ${vehicle?.vehicleType === 'triciclo_cuatrimoto' ? 'selected' : ''}>Triciclo / Cuatrimoto</option>
                                    </optgroup>
                                    <optgroup label="Vehículos Ligeros">
                                        <option value="automovil" ${vehicle?.vehicleType === 'automovil' ? 'selected' : ''}>Automóvil (Sedán, Coupé, etc)</option>
                                        <option value="suv_crossover" ${vehicle?.vehicleType === 'suv_crossover' ? 'selected' : ''}>SUV / Crossover</option>
                                        <option value="pickup" ${vehicle?.vehicleType === 'pickup' ? 'selected' : ''}>Camioneta (Pick-Up)</option>
                                        <option value="furgoneta_van" ${vehicle?.vehicleType === 'furgoneta_van' ? 'selected' : ''}>Furgoneta (Van)</option>
                                        <option value="minivan" ${vehicle?.vehicleType === 'minivan' ? 'selected' : ''}>Minivan</option>
                                    </optgroup>
                                    <optgroup label="Comerciales y Carga Pesada">
                                        <option value="camion_unitario" ${vehicle?.vehicleType === 'camion_unitario' ? 'selected' : ''}>Camión Unitario (Rígido)</option>
                                        <option value="tractocamion" ${vehicle?.vehicleType === 'tractocamion' ? 'selected' : ''}>Tractocamión (Tráiler)</option>
                                        <option value="autobus" ${vehicle?.vehicleType === 'autobus' ? 'selected' : ''}>Autobús / Microbús</option>
                                        <option value="remolque_caja_seca" ${vehicle?.vehicleType === 'remolque_caja_seca' ? 'selected' : ''}>Remolque (Caja Seca)</option>
                                        <option value="remolque_caja_refrigerada" ${vehicle?.vehicleType === 'remolque_caja_refrigerada' ? 'selected' : ''}>Remolque (Caja Refrigerada)</option>
                                        <option value="remolque_otro" ${vehicle?.vehicleType === 'remolque_otro' ? 'selected' : ''}>Remolque (Otro)</option>
                                    </optgroup>
                                    <optgroup label="Maquinaria y Especiales">
                                        <option value="maquinaria_construccion" ${vehicle?.vehicleType === 'maquinaria_construccion' ? 'selected' : ''}>Maquinaria de Construcción</option>
                                        <option value="maquinaria_agricola" ${vehicle?.vehicleType === 'maquinaria_agricola' ? 'selected' : ''}>Maquinaria Agrícola</option>
                                        <option value="grua" ${vehicle?.vehicleType === 'grua' ? 'selected' : ''}>Grúa</option>
                                        <option value="otro_especial" ${vehicle?.vehicleType === 'otro_especial' ? 'selected' : ''}>Otro Vehículo Especial</option>
                                    </optgroup>
                                </select>
                            </div>
                            <input type="text" name="plate" placeholder="Placas" value="${vehicle?.plate || ''}" required class="mt-1 block w-full border-gray-300 rounded-md self-end"/>
                            <input type="text" name="vin" placeholder="VIN / Número de Serie" value="${vehicle?.vin || ''}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="make" placeholder="Marca" value="${vehicle?.make || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="model" placeholder="Modelo" value="${vehicle?.model || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="number" name="year" placeholder="Año" value="${vehicle?.year || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="text" name="nickname" placeholder="Nickname" value="${vehicle?.nickname || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <div>
                                <select name="clientId" required class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="">Asignar a Cliente...</option>
                                    ${clientOptions}
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-vehicle-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-cyan-600 text-white px-4 py-2 rounded-lg">Guardar Vehículo</button>
                        </div>
                    </form>
                `;
                openModal(vehicle ? "Editar Vehículo" : "Nuevo Vehículo", formHtml);
            };

            const renderPersonnel = () => {
                const { personnel, currentUser } = state;
                let filteredPersonnel = personnel;

                if (currentUser.rolUsuario !== 'Master') {
                    filteredPersonnel = personnel.filter(p => p.rolUsuario !== 'Master');
                }

                const listHtml = filteredPersonnel.length > 0 ? filteredPersonnel.map(p => {
                          const roles = [];
                          if (p.isVendedor) roles.push('Vendedor');
                          if (p.isTecnico) roles.push('Técnico');
                          const displayRoles = roles.join(' / ') || 'N/A';
                          const displayType = p.type === 'activo' ? 'Colaborador Activo' : 'Col. Externo';
                          const typeBadge = createBadge(displayType, p.type === 'activo' ? 'bg-green-100' : 'bg-yellow-100', p.type === 'activo' ? 'text-green-800' : 'text-yellow-800');
                          const userRoleBadge = createBadge(p.rolUsuario || 'N/A', 'bg-gray-100', 'text-gray-800');

                return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayRoles}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${userRoleBadge}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${typeBadge}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.phone || p.email || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                                        <button class="edit-personnel-btn text-indigo-600 hover:text-indigo-900" data-id="${p.id}" title="Editar"><i data-lucide="edit" style="width:18px; height:18px;"></i></button>
                                        <button class="delete-personnel-btn text-red-600 hover:text-red-900" data-id="${p.id}" title="Eliminar"><i data-lucide="trash-2" style="width:18px; height:18px;"></i></button>
                                    </td>
                                </tr>
                                `
                }).join('') : `<tr><td colspan="6" class="text-center text-gray-500 py-4">No hay personal registrado.</td></tr>`;

                const html = `
                                  <div class="bg-white p-6 rounded-lg shadow-md">
                                       <div class="flex justify-between items-center mb-4">
                                           <h2 class="text-xl font-bold text-gray-800">Gestión de Personal Skytrix</h2>
                                           <button id="add-personnel-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center">
                                               <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nuevo Personal
                                           </button>
                                       </div>
                                       <div class="overflow-x-auto">
                                           <table class="min-w-full bg-white divide-y divide-gray-200">
                                               <thead class="bg-gray-50">
                                                   <tr>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol de Usuario</th>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                                   </tr>
                                               </thead>
                                               <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                                           </table>
                                       </div>
                                   </div>
                `;
                document.getElementById('view-personnel').innerHTML = html;
                lucide.createIcons();
            };
            
            const renderPersonnelForm = (person = null) => {
                const formHtml = `
                    <form id="personnel-form" data-id="${person?.id || ''}" class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900">Información General</h3>
                        <input type="text" name="name" placeholder="Nombre Completo" value="${person?.name || ''}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                        <input type="email" name="email" placeholder="Email" value="${person?.email || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                        <input type="tel" name="phone" placeholder="Teléfono" value="${person?.phone || ''}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                        <div>
                            <label class="block text-sm">Tipo de Colaborador</label>
                            <select name="type" class="mt-1 block w-full border-gray-300 rounded-md">
                                <option value="activo" ${person?.type === 'activo' ? 'selected' : ''}>Activo</option>
                                <option value="externo" ${person?.type === 'externo' ? 'selected' : ''}>Externo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm">Roles</label>
                            <div class="mt-2 space-y-2 border p-3 rounded-md">
                                <label class="flex items-center"><input type="checkbox" name="isVendedor" ${person?.isVendedor ? 'checked' : ''} class="h-4 w-4 rounded"> <span class="ml-2">Es Vendedor</span></label>
                                <label class="flex items-center"><input type="checkbox" name="isTecnico" ${person?.isTecnico ? 'checked' : ''} class="h-4 w-4 rounded"> <span class="ml-2">Es Técnico</span></label>
                            </div>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 pt-4 border-t mt-4">Credenciales de Acceso</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="usuario" placeholder="Usuario" value="${person?.usuario || ''}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                            <input type="password" name="contrasena" placeholder="Contraseña" value="${person?.contrasena || ''}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rol de Usuario</label>
                            <select name="rolUsuario" required class="mt-1 block w-full border-gray-300 rounded-md">
                                <option value="Administrador" ${person?.rolUsuario === 'Administrador' ? 'selected' : ''}>Administrador</option>
                                <option value="Estándar Ventas" ${person?.rolUsuario === 'Estándar Ventas' ? 'selected' : ''}>Estándar Ventas</option>
                                <option value="Estándar Técnicos" ${person?.rolUsuario === 'Estándar Técnicos' ? 'selected' : ''}>Estándar Técnicos</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-personnel-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Guardar</button>
                        </div>
                    </form>
                `;
                openModal(person ? 'Editar Personal' : 'Nuevo Personal', formHtml);
            };

            const renderBackups = () => {
                 const html = `
                                       <div class="bg-white p-6 rounded-lg shadow-md">
                                           <h2 class="text-xl font-bold text-gray-800 mb-4">Respaldos y Restauración</h2>
                                           <div id="backup-message" class="hidden p-3 rounded-md text-sm mb-4"></div>
                                           <div class="space-y-6">
                                               <div class="p-4 border rounded-lg">
                                                   <h3 class="font-semibold text-lg flex items-center"><i data-lucide="download" class="mr-2"></i>Crear un Respaldo</h3>
                                                   <p class="text-sm text-gray-600 mt-1 mb-3">Guarda toda la información actual del sistema en un archivo .json.</p>
                                                   <button id="export-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Crear y Descargar</button>
                                               </div>
                                               <div class="p-4 border rounded-lg">
                                                   <h3 class="font-semibold text-lg flex items-center"><i data-lucide="upload" class="mr-2"></i>Cargar un Respaldo</h3>
                                                   <p class="text-sm text-gray-600 mt-1 mb-3"><strong class="text-red-600">Esto sobrescribirá todos los datos actuales.</strong></p>
                                                   <input type="file" id="import-file" accept=".json" class="hidden"/>
                                                   <label for="import-file" class="bg-green-600 text-white px-4 py-2 rounded-lg cursor-pointer inline-block">Seleccionar Archivo</label>
                                               </div>
                                           </div>
                                       </div>`;
                document.getElementById('view-backups').innerHTML = html;
                lucide.createIcons();
            };

            const renderActivityLog = () => {
                const { activityLog } = state;
                // Sort logs by timestamp, newest first
                const sortedLog = activityLog.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                const logHtml = sortedLog.length > 0 ? sortedLog.map(log => {
                    const date = new Date(log.timestamp);
                    const formattedDate = `[${date.getFullYear()},${String(date.getMonth() + 1).padStart(2, '0')},${String(date.getDate()).padStart(2, '0')}]`;
                    const formattedTime = `[${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}]`;
                    return `
                        <div class="border-b pb-3 mb-3">
                            <p class="text-sm text-gray-500 font-mono">${formattedDate}, ${formattedTime}. Creado por: <span class="font-semibold text-gray-700">${log.userName}</span></p>
                            <p class="mt-1 text-gray-800">${log.action}</p>
                        </div>
                    `;
                }).join('') : `<p class="text-gray-500">No hay actividad registrada.</p>`;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Registro de Actividad del Sistema</h2>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">${logHtml}</div>
                    </div>
                `;
                document.getElementById('view-activity-log').innerHTML = html;
            };

            const renderWIP = (viewId, title) => {
                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">${title}</h2>
                        <p class="text-gray-600">Este módulo se encuentra en construcción.</p>
                    </div>`;
                document.getElementById(viewId).innerHTML = html;
            };
            
            const renderSearchResults = () => {
                const { searchTerm, clients, gpsDevices, vehicles, sims } = state;
                const lowerCaseSearch = searchTerm.toLowerCase();

                const filteredClients = clients.filter(c => c.name?.toLowerCase().includes(lowerCaseSearch) || c.company?.toLowerCase().includes(lowerCaseSearch));
                const filteredGps = gpsDevices.filter(g => g.deviceId?.toLowerCase().includes(lowerCaseSearch));
                const filteredVehicles = vehicles.filter(v => v.plate?.toLowerCase().includes(lowerCaseSearch) || v.vin?.toLowerCase().includes(lowerCaseSearch) || v.nickname?.toLowerCase().includes(lowerCaseSearch));
                const filteredSims = sims.filter(s => s.lineaSim?.toLowerCase().includes(lowerCaseSearch));

                const clientResults = filteredClients.map(c => `<div class="p-3 bg-gray-50 rounded-md border"><p class="font-semibold">${c.name} (${c.company})</p><p class="text-sm text-gray-600">Estado: ${statusBadge(c.status)}</p></div>`).join('');
                const vehicleResults = filteredVehicles.map(v => `<div class="p-3 bg-gray-50 rounded-md border"><p class="font-semibold">Placas: ${v.plate} / VIN: ${v.vin}</p><p class="text-sm text-gray-500">Cliente: ${v.clientName}</p></div>`).join('');
                const gpsResults = filteredGps.map(g => `<div class="p-3 bg-gray-50 rounded-md border"><p class="font-semibold">ID: ${g.deviceId}</p><p class="text-sm text-gray-600">Estado: ${locationBadge(g.status)}</p>${g.status === 'instalado' ? `<p class="text-sm text-gray-500">Cliente: ${g.clientName}</p>` : ''}</div>`).join('');
                const simResults = filteredSims.map(s => `<div class="p-3 bg-gray-50 rounded-md border"><p class="font-semibold">Línea: ${s.lineaSim}</p><p class="text-sm text-gray-600">Estado: ${simStatusBadge(s.status)}</p><p class="text-sm text-gray-500">Equipo Asignado: ${s.assignedGpsId || 'N/A'}</p></div>`).join('');

                const noResults = filteredClients.length === 0 && filteredGps.length === 0 && filteredVehicles.length === 0 && filteredSims.length === 0;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Resultados de la Búsqueda</h2>
                            <button id="clear-search-btn" class="text-blue-600 hover:text-blue-800 flex items-center"><i data-lucide="x" class="mr-1" style="width:18px;height:18px;"></i> Limpiar Búsqueda</button>
                        </div>
                        ${noResults ? '<p class="text-gray-500">No se encontraron resultados.</p>' : `
                            <div class="space-y-6">
                                ${filteredClients.length > 0 ? `<div><h3 class="text-lg font-semibold mb-2">Clientes</h3><div class="space-y-2">${clientResults}</div></div>` : ''}
                                ${filteredVehicles.length > 0 ? `<div><h3 class="text-lg font-semibold mb-2">Vehículos</h3><div class="space-y-2">${vehicleResults}</div></div>` : ''}
                                ${filteredGps.length > 0 ? `<div><h3 class="text-lg font-semibold mb-2">Equipos GPS</h3><div class="space-y-2">${gpsResults}</div></div>` : ''}
                                ${filteredSims.length > 0 ? `<div><h3 class="text-lg font-semibold mb-2">Tarjetas SIM</h3><div class="space-y-2">${simResults}</div></div>` : ''}
                            </div>
                        `}
                    </div>
                `;
                
                document.getElementById('view-search-results').innerHTML = html;
                lucide.createIcons();
            };

            const renderSims = () => {
                const { sims } = state;
                const listHtml = sims.length > 0 ? sims.map(sim => `
                    <tr key="${sim.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sim.lineaSim}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sim.imeiSim}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${simStatusBadge(sim.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sim.assignedGpsId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-sim-btn text-indigo-600 hover:text-indigo-900" data-id="${sim.id}"><i data-lucide="edit" style="width:18px; height:18px;"></i></button>
                        </td>
                    </tr>
                `).join('') : `<tr><td colspan="5" class="text-center text-gray-500 py-4">No hay tarjetas SIM registradas.</td></tr>`;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Gestión de Tarjetas SIM</h2>
                            <button id="add-sim-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nueva Tarjeta SIM
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Línea Telefónica</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IMEI SIM</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo Asignado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('view-sims').innerHTML = html;
                lucide.createIcons();
            };

            const renderSimForm = (sim = null) => {
                const formHtml = `
                    <form id="sim-form" data-id="${sim?.id || ''}" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Línea Telefónica SIM</label>
                            <input type="text" name="lineaSim" value="${sim?.lineaSim || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">IMEI SIM</label>
                            <input type="text" name="imeiSim" value="${sim?.imeiSim || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Estado</label>
                            <select name="status" id="sim-status-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="almacen_skytrix" ${sim?.status === 'almacen_skytrix' ? 'selected' : ''}>Almacén Skytrix</option>
                                <option value="activada" ${sim?.status === 'activada' ? 'selected' : ''}>Activada</option>
                                <option value="asignada" ${sim?.status === 'asignada' ? 'selected' : ''}>Asignada</option>
                                <option value="instalada" ${sim?.status === 'instalada' ? 'selected' : ''}>Instalada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ID Equipo GPS (Opcional)</label>
                            <input type="text" name="assignedGpsId" value="${sim?.assignedGpsId || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"/>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-sim-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar SIM</button>
                        </div>
                    </form>
                `;
                openModal(sim ? "Editar Tarjeta SIM" : "Nueva Tarjeta SIM", formHtml);
            };

            // --- SALES MODULE FUNCTIONS ---
            const getAccessoryInventory = () => {
                const inventory = { sos: 0, relay: 0, mic: 0, fuel: 0, temp: 0, camera: 0 };
                state.gpsDevices
                    .filter(device => device.status === 'almacen')
                    .forEach(device => {
                        if (device.accessories) {
                            for (const key in device.accessories) {
                                if (device.accessories[key] === true) {
                                    inventory[key]++;
                                }
                            }
                        }
                    });
                return inventory;
            };

            const renderVentas = () => {
                const { sales } = state;
                const listHtml = sales.length > 0 ? sales.map(sale => `
                    <tr key="${sale.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(sale.saleDate).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.salesRepName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.vehicleInfo || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.packageType ? formatVehicleType(sale.packageType) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right text-gray-900">${formatCurrency(sale.totalCost)}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="delete-sale-btn text-red-600 hover:text-red-900" data-id="${sale.id}" title="Eliminar"><i data-lucide="trash-2" style="width:18px; height:18px;"></i></button>
                        </td>
                    </tr>
                `).join('') : `<tr><td colspan="7" class="text-center text-gray-500 py-4">No hay ventas registradas.</td></tr>`;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Registro de Ventas Skytrix</h2>
                            <button id="add-sale-btn" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center">
                                <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nueva Venta
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paquete</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('view-ventas').innerHTML = html;
                lucide.createIcons();
            };

            const renderVentaForm = () => {
                const { clients, personnel, gpsDevices } = state;
                const salesReps = personnel.filter(p => p.isVendedor);
                const availableGps = gpsDevices.filter(g => g.status === 'almacen');
                const accessoryInventory = getAccessoryInventory();

                const clientOptions = clients.map(c => `<option value="${c.id}">${c.company || c.name}</option>`).join('');
                const salesRepOptions = salesReps.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const gpsOptions = availableGps.map(g => `<option value="${g.id}" data-model="${g.model}">${g.deviceId} (${g.model})</option>`).join('');
                const accessoryCheckboxes = Object.keys(PRICES.ACCESSORIES).map(key => {
                    const count = accessoryInventory[key] || 0;
                    const disabled = count === 0 ? 'disabled' : '';
                    const labelColor = count === 0 ? 'text-gray-400' : '';
                    return `
                        <label class="flex items-center ${labelColor}">
                            <input type="checkbox" name="accessory" value="${key}" class="h-4 w-4 rounded border-gray-300 sale-cost-calculator" ${disabled}> 
                            <span class="ml-2">${key.charAt(0).toUpperCase() + key.slice(1)} (${count} disp.)</span>
                        </label>
                    `;
                }).join('');

                const formHtml = `
                    <form id="sale-form" class="space-y-6">
                        <!-- Sale Details -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Detalles de la Venta</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Cliente</label>
                                    <select name="clientId" id="sale-form-client-select" required class="mt-1 block w-full border-gray-300 rounded-md"><option value="">Seleccionar Cliente</option>${clientOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Vendedor</label>
                                    <select name="salesRepId" required class="mt-1 block w-full border-gray-300 rounded-md"><option value="">Seleccionar Vendedor</option>${salesRepOptions}</select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Vehículo</label>
                                    <select name="vehicleId" id="sale-form-vehicle-select" required class="mt-1 block w-full border-gray-300 rounded-md" disabled><option value="">Seleccione un cliente primero</option></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Category and Package -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Categoría y Paquete</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Categoría de Equipo</label>
                                    <select name="equipmentCategory" required class="mt-1 block w-full border-gray-300 rounded-md">
                                        <option value="">Seleccionar Categoría</option>
                                        <option value="Skytrix for Family">Skytrix for Family</option>
                                        <option value="Skytrix for Fleet">Skytrix for Fleet</option>
                                        <option value="Skytrix for Pets">Skytrix for Pets</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Paquete Ofrecido</label>
                                    <select name="packageType" id="sale-package-select" required class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator">
                                        <option value="">Seleccionar Paquete</option>
                                        <option value="basico_moto">Básico p/Moto (${formatCurrency(PRICES.PACKAGES.basico_moto)})</option>
                                        <option value="basico_auto">Básico p/Auto (${formatCurrency(PRICES.PACKAGES.basico_auto)})</option>
                                        <option value="sos">SOS (${formatCurrency(PRICES.PACKAGES.sos)})</option>
                                        <option value="premium">Premium (${formatCurrency(PRICES.PACKAGES.premium)})</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Equipment -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Equipo y Accesorios</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Equipo GPS (de Almacén)</label>
                                    <select name="gpsDeviceId" required class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator"><option value="">Seleccionar Equipo</option>${gpsOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Costo del Equipo Ofrecido</label>
                                    <input type="number" name="gpsManualCost" id="gps-manual-cost" class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator" placeholder="Costo de lista">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Descuento Equipo (%)</label>
                                    <input type="number" name="gpsDiscountPercentage" class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator" placeholder="Ej: 10">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Accesorios Incluidos con el Equipo</label>
                                <div id="included-accessories-display" class="mt-2 p-3 grid grid-cols-2 gap-2 border rounded-md bg-gray-50 min-h-[40px] text-sm text-gray-600">
                                    Seleccione un equipo para ver sus accesorios.
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Accesorios Adicionales</label>
                                <div class="mt-2 grid grid-cols-2 gap-2 border p-3 rounded-md">${accessoryCheckboxes}</div>
                            </div>
                        </div>

                        <!-- Service Plan -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-4">Plan de Servicio</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Costo de Servicio</label>
                                    <select name="serviceType" required class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator">
                                        <option value="">Seleccionar Plan</option>
                                        <option value="mensual_250">Plan Mensual - ${formatCurrency(PRICES.SERVICES.mensual_250)}</option>
                                        <option value="mensual_300">Plan Mensual - ${formatCurrency(PRICES.SERVICES.mensual_300)}</option>
                                        <option value="anual_3000">Plan Anual - ${formatCurrency(PRICES.SERVICES.anual_3000)}</option>
                                        <option value="anual_3600">Plan Anual - ${formatCurrency(PRICES.SERVICES.anual_3600)}</option>
                                    </select>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700">Descuento Servicio (%)</label>
                                    <input type="number" name="serviceDiscountPercentage" class="mt-1 block w-full border-gray-300 rounded-md sale-cost-calculator" placeholder="Solo para plan anual">
                                </div>
                            </div>
                            <div class="md:col-span-2 mt-4">
                                <label class="flex items-center text-sm font-medium text-gray-400" id="label-mensualidad-gratis">
                                    <input type="checkbox" name="primeraMensualidadGratis" id="primera-mensualidad-gratis" class="h-4 w-4 rounded border-gray-300 sale-cost-calculator" disabled>
                                    <span class="ml-2">Primera Mensualidad Gratuita</span>
                                </label>
                            </div>
                        </div>

                        <!-- Cost Summary -->
                        <div class="bg-gray-50 p-4 rounded-lg mt-6">
                             <h3 class="text-lg font-medium text-gray-900 mb-2">Resumen de Costos</h3>
                             <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>Subtotal Equipo:</span><span id="cost-gps"></span></div>
                                <div class="flex justify-between text-red-600"><span>Descuento Equipo:</span><span id="cost-gps-discount"></span></div>
                                <div class="flex justify-between"><span>Subtotal Accesorios Adicionales:</span><span id="cost-accessories"></span></div>
                                <div class="flex justify-between"><span>Subtotal Servicio:</span><span id="cost-service"></span></div>
                                <div class="flex justify-between text-red-600"><span>Descuento Servicio:</span><span id="cost-service-discount"></span></div>
                                <div class="flex justify-between text-red-600"><span>Promoción 1ra Mensualidad:</span><span id="cost-free-month"></span></div>
                                <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>Total Final:</span><span id="cost-total"></span></div>
                             </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-sale-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-lg">Registrar Venta</button>
                        </div>
                    </form>
                `;
                openModal("Registrar Nueva Venta", formHtml);
            };

            const updateSaleCosts = () => {
                const form = document.getElementById('sale-form');
                if (!form) return;

                let gpsCost = 0;
                let accessoriesCost = 0;
                let serviceCost = 0;

                // GPS Cost - PRIORITIZE MANUAL INPUT
                const manualCostInput = form.querySelector('#gps-manual-cost');
                if (manualCostInput && manualCostInput.value) {
                    gpsCost = parseFloat(manualCostInput.value) || 0;
                } else {
                    const packageSelect = form.querySelector('#sale-package-select');
                    const selectedPackage = packageSelect.value;
                    gpsCost = PRICES.PACKAGES[selectedPackage] || 0;
                }

                // Accessories Cost
                form.querySelectorAll('input[name="accessory"]:checked').forEach(checkbox => {
                    accessoriesCost += PRICES.ACCESSORIES[checkbox.value] || 0;
                });

                // Service Cost
                const serviceType = form.querySelector('[name="serviceType"]').value;
                if (serviceType) {
                    serviceCost = PRICES.SERVICES[serviceType] || 0;
                }
                
                // Discount Calculations
                const gpsDiscountPercentage = parseFloat(form.querySelector('[name="gpsDiscountPercentage"]').value) || 0;
                const gpsDiscountAmount = (gpsCost * gpsDiscountPercentage) / 100;

                let serviceDiscountAmount = 0;
                let freeMonthDiscount = 0;
                const freeMonthCheckbox = form.querySelector('#primera-mensualidad-gratis');

                if (serviceType.startsWith('anual')) {
                    const serviceDiscountPercentage = parseFloat(form.querySelector('[name="serviceDiscountPercentage"]').value) || 0;
                    serviceDiscountAmount = (serviceCost * serviceDiscountPercentage) / 100;
                    
                    if (freeMonthCheckbox && freeMonthCheckbox.checked) {
                        freeMonthDiscount = serviceCost / 12;
                    }
                }

                const totalCost = (gpsCost - gpsDiscountAmount) + accessoriesCost + (serviceCost - serviceDiscountAmount - freeMonthDiscount);

                document.getElementById('cost-gps').textContent = formatCurrency(gpsCost);
                document.getElementById('cost-gps-discount').textContent = `- ${formatCurrency(gpsDiscountAmount)}`;
                document.getElementById('cost-accessories').textContent = formatCurrency(accessoriesCost);
                document.getElementById('cost-service').textContent = formatCurrency(serviceCost);
                document.getElementById('cost-service-discount').textContent = `- ${formatCurrency(serviceDiscountAmount)}`;
                document.getElementById('cost-free-month').textContent = `- ${formatCurrency(freeMonthDiscount)}`;
                document.getElementById('cost-total').textContent = formatCurrency(totalCost);
            };

            const renderServiciosSkytrix = () => {
                const { serviciosSkytrix } = state;
                const listHtml = serviciosSkytrix.length > 0 ? serviciosSkytrix.map(item => `
                    <tr key="${item.id}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.fecha).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.technicianName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.vehicleInfo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tipoServicio}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.numeroActa}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="delete-servicio-btn text-red-600 hover:text-red-900" data-id="${item.id}" title="Eliminar"><i data-lucide="trash-2" style="width:18px; height:18px;"></i></button>
                        </td>
                    </tr>
                `).join('') : `<tr><td colspan="7" class="text-center text-gray-500 py-4">No hay servicios registrados.</td></tr>`;

                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Registro de Servicios Skytrix</h2>
                            <button id="add-servicio-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                                <i data-lucide="plus-circle" class="mr-2" style="width:18px; height:18px;"></i> Nuevo Servicio
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo de Servicio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Acta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${listHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('view-servicios-skytrix').innerHTML = html;
                lucide.createIcons();
            };

            const renderServicioForm = async () => {
                const { clients, personnel, serviciosSkytrix } = state;
                const technicians = personnel.filter(p => p.isTecnico);
                
                const clientOptions = clients.map(c => `<option value="${c.id}">${c.company || c.name}</option>`).join('');
                const techOptions = technicians.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const existingToday = serviciosSkytrix.filter(i => i.numeroActa && i.numeroActa.includes(today));
                const nextId = String(existingToday.length + 1).padStart(3, '0');
                const actaNumber = `SKTXSERV-${today}-${nextId}`;

                const formHtml = `
                    <form id="servicio-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" name="fecha" value="${new Date().toISOString().slice(0, 10)}" required class="mt-1 block w-full border-gray-300 rounded-md"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Número de Acta</label>
                                <input type="text" name="numeroActa" placeholder="Ej. ${actaNumber}" class="mt-1 block w-full border-gray-300 rounded-md"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Cliente</label>
                                <select name="clientId" id="servicio-form-client-select" required class="mt-1 block w-full border-gray-300 rounded-md"><option value="">Seleccionar Cliente</option>${clientOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Vehículo</label>
                                <select name="vehicleId" id="servicio-form-vehicle-select" required class="mt-1 block w-full border-gray-300 rounded-md" disabled><option value="">Seleccione un cliente</option></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Técnico</label>
                                <select name="technicianId" required class="mt-1 block w-full border-gray-300 rounded-md"><option value="">Seleccionar Técnico</option>${techOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tipo de Servicio</label>
                                <select name="tipoServicio" required class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="Instalación">Instalación</option>
                                    <option value="Servicio">Servicio</option>
                                    <option value="Desinstalación">Desinstalación</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Categoría de Equipo</label>
                                <select name="equipmentCategory" class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="">Seleccionar Categoría</option>
                                    <option value="Skytrix for Family">Skytrix for Family</option>
                                    <option value="Skytrix for Fleet">Skytrix for Fleet</option>
                                    <option value="Skytrix for Pets">Skytrix for Pets</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Paquete GPS Instalado</label>
                                <select name="packageType" class="mt-1 block w-full border-gray-300 rounded-md">
                                    <option value="">Seleccionar Paquete</option>
                                    <option value="basico_moto">Básico p/Moto</option>
                                    <option value="basico_auto">Básico p/Auto</option>
                                    <option value="sos">SOS</option>
                                    <option value="premium">Premium</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-servicio-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg">Guardar Registro</button>
                        </div>
                    </form>
                `;
                openModal("Nuevo Servicio Skytrix", formHtml);
            };

            // --- NAVIGATION & ROUTING ---
            const navigateTo = (view, isRefresh = false) => {
                if (!isRefresh) {
                    state.searchTerm = '';
                    document.getElementById('search-term').value = '';
                }
                state.currentView = view;

                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-button').forEach(b => {
                    b.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold');
                    b.classList.add('text-gray-600', 'hover:bg-gray-100');
                });

                let targetViewId = `view-${view}`;
                let activeView = document.getElementById(targetViewId);
                
                if (activeView) {
                    activeView.classList.add('active');
                    const navButton = document.querySelector(`.nav-button[data-view="${view}"]`);
                    if (navButton) {
                        navButton.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
                    }
                }

                switch(view) {
                    case 'dashboard': renderDashboard(); break;
                    case 'kpis-ventas': renderKpisVentas(); break;
                    case 'kpis-servicios': renderKpisServicios(); break;
                    case 'comisiones': renderComisiones(); break;
                    case 'contrato-de-servicios': renderContratos(); break;
                    case 'gps': renderGps(); break;
                    case 'clients': renderClients(); break;
                    case 'vehicles': renderVehicles(); break;
                    case 'personnel': renderPersonnel(); break;
                    case 'sims': renderSims(); break;
                    case 'ventas': renderVentas(); break;
                    case 'servicios-skytrix': renderServiciosSkytrix(); break;
                    case 'backups': renderBackups(); break;
                    case 'activity-log': renderActivityLog(); break;
                }
            };

            const renderContratos = () => {
                const html = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Contratos de Servicio</h2>
                        
                        <!-- Skytrix for Fleet -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Skytrix for Fleet</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- Card: Básico (Moto) -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">Básico (Moto)</h4>
                                    <p class="text-sm text-gray-600 mt-2">Contrato de servicio esencial para motocicletas.</p>
                                    <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 text-sm">Ver Detalles</button>
                                </div>
                                <!-- Card: Básico (Auto) -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">Básico (Auto)</h4>
                                    <p class="text-sm text-gray-600 mt-2">Contrato de servicio esencial para automóviles.</p>
                                    <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 text-sm">Ver Detalles</button>
                                </div>
                                <!-- Card: SOS -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">SOS</h4>
                                    <p class="text-sm text-gray-600 mt-2">Incluye botón de pánico y asistencia vial.</p>
                                    <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 text-sm">Ver Detalles</button>
                                </div>
                                <!-- Card: Premium -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">Premium</h4>
                                    <p class="text-sm text-gray-600 mt-2">Todas las funcionalidades, incluyendo accesorios avanzados.</p>
                                    <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 text-sm">Ver Detalles</button>
                                </div>
                            </div>
                        </div>

                        <!-- Skytrix for Family -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Skytrix for Family</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                 <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">Plan Familiar</h4>
                                    <p class="text-sm text-gray-600 mt-2">Protección y seguimiento para los vehículos de tu familia.</p>
                                    <button class="mt-4 w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 text-sm">Ver Detalles</button>
                                </div>
                            </div>
                        </div>

                        <!-- Skytrix for Pets -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Skytrix for Pets</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                 <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-lg transition-shadow">
                                    <h4 class="font-bold text-lg text-gray-800">Plan Mascotas</h4>
                                    <p class="text-sm text-gray-600 mt-2">Localización y seguridad para tus compañeros peludos.</p>
                                    <button class="mt-4 w-full bg-purple-500 text-white py-2 rounded-md hover:bg-purple-600 text-sm">Ver Detalles</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('view-contrato-de-servicios').innerHTML = html;
            };

            // --- EVENT LISTENERS ---
            const setupEventListeners = () => {
                // Navigation
                document.getElementById('sidebar-nav').addEventListener('click', (e) => {
                    const button = e.target.closest('.nav-button');
                    if (button) {
                        const view = button.dataset.view;
                        if (view === 'actas-de-servicio') {
                            window.open('https://g.co/gemini/share/00f53e7a3c1a', '_blank');
                        } else {
                            navigateTo(view);
                        }
                    }
                });

                // Search
                document.getElementById('search-term').addEventListener('keyup', (e) => {
                    state.searchTerm = e.target.value;
                    if (state.searchTerm) {
                        renderSearchResults();
                        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                        document.getElementById('view-search-results').classList.add('active');
                    } else {
                        navigateTo(state.currentView);
                    }
                });
                
                // Modal close buttons
                document.getElementById('modal-close-btn').addEventListener('click', closeModal);
                document.getElementById('gemini-modal-close-btn').addEventListener('click', closeGeminiModal);
                
                // --- Event Delegation for dynamic content ---
                mainContent.addEventListener('click', e => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    if (target.id === 'clear-search-btn') navigateTo(state.currentView);
                    if (target.id === 'add-gps-btn') renderGpsForm();
                    if (target.classList.contains('edit-gps-btn')) {
                        const gps = state.gpsDevices.find(g => g.id === target.dataset.id);
                        renderGpsForm(gps);
                    }
                     if (target.classList.contains('delete-gps-btn')) {
                        const gpsId = target.dataset.id;
                        const gps = state.gpsDevices.find(g => g.id === gpsId);
                        if (gps) {
                            openModal('Confirmar Eliminación', `
                                <p class="mb-4">¿Estás seguro de que deseas eliminar el equipo <strong>${gps.deviceId}</strong>?</p>
                                <p class="text-sm text-red-600">Esta acción no se puede deshacer.</p>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Eliminar</button>
                                </div>
                            `);

                            document.getElementById('confirm-delete-btn').onclick = async () => {
                                await dbService.delete('gpsDevices', gpsId);
                                closeModal();
                            };
                            document.getElementById('cancel-delete-btn').onclick = closeModal;
                        }
                    }
                    if (target.id === 'add-client-btn') renderClientForm();
                    if (target.classList.contains('edit-client-btn')) {
                        const client = state.clients.find(c => c.id === target.dataset.id);
                        renderClientForm(client);
                    }
                    if(target.classList.contains('remind-client-btn')) {
                         const client = state.clients.find(c => c.id === target.dataset.id);
                         const prompt = `Escribe un recordatorio de pago amigable pero profesional para nuestro cliente "${client.name}" de la empresa "${client.company}". Menciona que hemos notado un atraso en su pago más reciente. Ofrécele ayuda y sugiérele ponerse en contacto.`;
                         generateGeminiContent(prompt);
                    }
                    if (target.id === 'add-vehicle-btn') renderVehicleForm();
                    if (target.classList.contains('edit-vehicle-btn')) {
                        const vehicle = state.vehicles.find(v => v.id === target.dataset.id);
                        renderVehicleForm(vehicle);
                    }
                    if (target.id === 'add-personnel-btn') renderPersonnelForm();
                    if (target.classList.contains('edit-personnel-btn')) {
                        const person = state.personnel.find(p => p.id === target.dataset.id);
                        renderPersonnelForm(person);
                    }
                    if (target.classList.contains('delete-personnel-btn')) {
                        const personId = target.dataset.id;
                        const person = state.personnel.find(p => p.id === personId);
                        if (person) {
                            openModal('Confirmar Eliminación', `
                                <p class="mb-4">¿Estás seguro de que deseas eliminar a <strong>${person.name}</strong>?</p>
                                <p class="text-sm text-red-600">Esta acción no se puede deshacer.</p>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Eliminar</button>
                                </div>
                            `);

                            document.getElementById('confirm-delete-btn').onclick = async () => {
                                await dbService.delete('personnel', personId);
                                closeModal();
                            };
                            document.getElementById('cancel-delete-btn').onclick = closeModal;
                        }
                    }
                    if (target.classList.contains('delete-sale-btn')) {
                        const saleId = target.dataset.id;
                        const sale = state.sales.find(s => s.id === saleId);
                        if (sale) {
                            openModal('Confirmar Eliminación', `
                                <p class="mb-4">¿Estás seguro de que deseas eliminar la venta para <strong>${sale.clientName}</strong>?</p>
                                <p class="text-sm text-red-600">Esta acción no se puede deshacer.</p>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Eliminar</button>
                                </div>
                            `);

                            document.getElementById('confirm-delete-btn').onclick = async () => {
                                await dbService.delete('sales', saleId);
                                closeModal();
                            };
                            document.getElementById('cancel-delete-btn').onclick = closeModal;
                        }
                    }
                    if (target.id === 'add-sim-btn') renderSimForm();
                    if (target.classList.contains('edit-sim-btn')) {
                        const sim = state.sims.find(s => s.id === target.dataset.id);
                        renderSimForm(sim);
                    }
                    if (target.id === 'add-sale-btn') renderVentaForm();
                    if (target.id === 'add-servicio-btn') renderServicioForm();
                    if (target.classList.contains('delete-servicio-btn')) {
                        const servicioId = target.dataset.id;
                        const servicio = state.serviciosSkytrix.find(i => i.id === servicioId);
                        if (servicio) {
                            openModal('Confirmar Eliminación', `
                                <p class="mb-4">¿Seguro que deseas eliminar el registro <strong>${servicio.numeroActa}</strong>?</p>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="cancel-delete-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancelar</button>
                                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Eliminar</button>
                                </div>
                            `);
                            document.getElementById('confirm-delete-btn').onclick = async () => {
                                await dbService.delete('serviciosSkytrix', servicioId);
                                closeModal();
                            };
                            document.getElementById('cancel-delete-btn').onclick = closeModal;
                        }
                    }
                    if (target.id === 'export-btn') {
                        const allData = {
                            gpsDevices: state.gpsDevices,
                            clients: state.clients,
                            personnel: state.personnel,
                            vehicles: state.vehicles,
                            sims: state.sims,
                            sales: state.sales,
                            serviciosSkytrix: state.serviciosSkytrix,
                        };
                        const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(allData, null, 2))}`;
                        const link = document.createElement("a");
                        const date = new Date().toISOString().slice(0, 10);
                        link.href = jsonString;
                        link.download = `skytrix_backup_${date}.json`;
                        link.click();
                    }
                });

                mainContent.addEventListener('change', e => {
                    const view = state.currentView;
                    if (e.target.id === 'kpi-personnel-filter') {
                        state.kpiPersonnelFilter = e.target.value;
                        if(view === 'kpis-ventas') renderKpisVentas();
                        if(view === 'comisiones') renderComisiones();
                    }
                     if (e.target.id === 'commission-type-filter') {
                        state.commissionTypeFilter = e.target.value;
                        state.kpiPersonnelFilter = 'all'; // Reset personnel filter
                        if(view === 'comisiones') renderComisiones();
                    }
                    if (e.target.id === 'kpi-technician-filter') {
                        state.kpiTechnicianFilter = e.target.value;
                        if(view === 'kpis-servicios') renderKpisServicios();
                    }
                    if (e.target.id === 'kpi-service-type-filter') {
                        state.kpiServiceTypeFilter = e.target.value;
                        if(view === 'kpis-servicios') renderKpisServicios();
                    }
                    if (e.target.id === 'kpi-period-filter') {
                        state.kpiPeriodFilter = e.target.value;
                        const now = new Date();
                        switch(state.kpiPeriodFilter) {
                            case 'day':
                                state.kpiDateFilter = now.toISOString().slice(0, 10); // YYYY-MM-DD
                                break;
                            case 'week':
                                const year = now.getFullYear();
                                const week = Math.ceil((((now - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);
                                state.kpiDateFilter = `${year}-W${String(week).padStart(2, '0')}`;
                                break;
                            case 'month':
                                state.kpiDateFilter = now.toISOString().slice(0, 7); // YYYY-MM
                                break;
                            case 'year':
                                state.kpiDateFilter = now.getFullYear().toString();
                                break;
                        }
                        if(view === 'kpis-ventas') renderKpisVentas();
                        if(view === 'comisiones') renderComisiones();
                        if(view === 'kpis-servicios') renderKpisServicios();
                    }
                    if (e.target.id === 'kpi-date-input') {
                        state.kpiDateFilter = e.target.value;
                        if(view === 'kpis-ventas') renderKpisVentas();
                        if(view === 'comisiones') renderComisiones();
                        if(view === 'kpis-servicios') renderKpisServicios();
                    }
                    if (e.target.id === 'import-file') {
                        const file = e.target.files[0];
                        if (file && file.type === "application/json") {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                try {
                                    const backupData = JSON.parse(event.target.result);
                                    openModal('Confirmar Restauración', `
                                        <p class="mb-4">¿Seguro que quieres restaurar desde este archivo? Se sobrescribirán todos los datos actuales.</p>
                                        <div class="flex justify-end space-x-2">
                                            <button id="confirm-restore-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                                            <button id="confirm-restore-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Restaurar</button>
                                        </div>
                                    `);
                                    document.getElementById('confirm-restore-btn').onclick = async () => {
                                        await dbService.restore(backupData);
                                        closeModal();
                                        openModal('Éxito', '<p>Datos restaurados correctamente.</p>');
                                    };
                                    document.getElementById('confirm-restore-cancel').onclick = closeModal;

                                } catch (err) {
                                    openModal('Error', '<p>El archivo de respaldo es inválido.</p>');
                                }
                            };
                            reader.readAsText(file);
                        }
                        e.target.value = null;
                    }
                });

                // --- Event Listeners for Forms ---
                modalContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if(!target) return;
                    if(target.id.startsWith('cancel-')) {
                        closeModal();
                    }
                    if(target.id === 'generate-checklist-btn') {
                         const model = modalContent.querySelector('[name="model"]').value || 'desconocido';
                         const prompt = `Crea una checklist detallada para un técnico que va a instalar un equipo GPS modelo "${model}" en un vehículo. Incluye secciones para: 1. Preparación Pre-Instalación. 2. Instalación Física. 3. Configuración y Pruebas. 4. Cierre con el Cliente.`;
                         generateGeminiContent(prompt);
                    }
                });
                
                modalContainer.addEventListener('change', (e) => {
                    if (e.target.classList.contains('sale-cost-calculator')) {
                        updateSaleCosts();
                    }
                     if (e.target.id === 'sale-package-select') {
                        const selectedPackage = e.target.value;
                        const packageCost = PRICES.PACKAGES[selectedPackage] || 0;
                        const manualCostInput = document.getElementById('gps-manual-cost');
                        manualCostInput.value = packageCost;
                        updateSaleCosts();
                    }
                    if (e.target.name === 'serviceType' && e.target.closest('#sale-form')) {
                        const serviceType = e.target.value;
                        const freeMonthCheckbox = document.getElementById('primera-mensualidad-gratis');
                        const freeMonthLabel = document.getElementById('label-mensualidad-gratis');
                        
                        if (serviceType.startsWith('anual')) {
                            freeMonthCheckbox.disabled = false;
                            freeMonthLabel.classList.remove('text-gray-400');
                            freeMonthLabel.classList.add('text-gray-700');
                        } else {
                            freeMonthCheckbox.disabled = true;
                            freeMonthCheckbox.checked = false;
                            freeMonthLabel.classList.add('text-gray-400');
                            freeMonthLabel.classList.remove('text-gray-700');
                        }
                    }
                    if (e.target.name === 'gpsDeviceId' && e.target.closest('#sale-form')) {
                        const gpsId = e.target.value;
                        const displayDiv = document.getElementById('included-accessories-display');
                        
                        if (gpsId) {
                            const selectedGps = state.gpsDevices.find(g => g.id === gpsId);
                            if (selectedGps && selectedGps.accessories) {
                                const included = Object.entries(selectedGps.accessories)
                                    .filter(([key, value]) => value === true)
                                    .map(([key]) => key); 
                                
                                if (included.length > 0) {
                                    displayDiv.innerHTML = included.map(accKey => `
                                        <label class="flex items-center">
                                            <input type="checkbox" name="included_accessory" value="${accKey}" class="h-4 w-4 rounded border-gray-300" checked>
                                            <span class="ml-2">${formatVehicleType(accKey)}</span>
                                        </label>
                                    `).join('');
                                } else {
                                    displayDiv.textContent = 'Este equipo no tiene accesorios incluidos.';
                                }
                            } else {
                                displayDiv.textContent = 'No se encontraron detalles de accesorios para este equipo.';
                            }
                        } else {
                            displayDiv.textContent = 'Seleccione un equipo para ver sus accesorios.';
                        }
                        updateSaleCosts();
                    }
                    if (e.target.id === 'gps-status-select') {
                        const status = e.target.value;
                        const installationFields = document.getElementById('installation-fields');
                        const inventoryFields = document.getElementById('inventory-fields');
                        if (status === 'instalado' || status === 'senuelo' || status === 'cita_instalacion') {
                            installationFields.classList.remove('hidden');
                            inventoryFields.classList.add('hidden');
                        } else {
                            installationFields.classList.add('hidden');
                            inventoryFields.classList.remove('hidden');
                        }
                    }
                     if (e.target.id === 'gps-form-client-select') {
                        const clientId = e.target.value;
                        const vehicleSelect = document.getElementById('gps-form-vehicle-select');
                        const availableVehicles = state.vehicles.filter(v => v.clientId === clientId);
                        vehicleSelect.innerHTML = '<option value="">Seleccionar Vehículo</option>' + availableVehicles.map(v => `<option value="${v.id}">${v.make} ${v.model} (${v.plate})</option>`).join('');
                    }
                    if (e.target.id === 'sale-form-client-select') {
                        const clientId = e.target.value;
                        const vehicleSelect = document.getElementById('sale-form-vehicle-select');
                        if (clientId) {
                            const availableVehicles = state.vehicles.filter(v => v.clientId === clientId);
                            vehicleSelect.innerHTML = '<option value="">Seleccionar Vehículo</option>' + availableVehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate} (${v.make} ${v.model})</option>`).join('');
                            vehicleSelect.disabled = false;
                        } else {
                            vehicleSelect.innerHTML = '<option value="">Seleccione un cliente primero</option>';
                            vehicleSelect.disabled = true;
                        }
                    }
                    if (e.target.id === 'servicio-form-client-select') {
                        const clientId = e.target.value;
                        const vehicleSelect = document.getElementById('servicio-form-vehicle-select');
                        if (clientId) {
                            const availableVehicles = state.vehicles.filter(v => v.clientId === clientId);
                            vehicleSelect.innerHTML = '<option value="">Seleccionar Vehículo</option>' + availableVehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate} (${v.make} ${v.model})</option>`).join('');
                            vehicleSelect.disabled = false;
                        } else {
                            vehicleSelect.innerHTML = '<option value="">Seleccione un cliente primero</option>';
                            vehicleSelect.disabled = true;
                        }
                    }
                });

                const handleSimFormSubmit = async (form, id, data) => {
                    const simId = id;
                    const { lineaSim, imeiSim, assignedGpsId } = data;

                    // 1. Uniqueness check
                    const isLineaSimDuplicate = state.sims.some(sim => sim.lineaSim === lineaSim && sim.id !== simId);
                    if (isLineaSimDuplicate) {
                        openModal('Error de Duplicado', '<p>La Línea Telefónica SIM que ingresaste ya existe en el sistema.</p>');
                        return;
                    }
                    const isImeiSimDuplicate = state.sims.some(sim => sim.imeiSim === imeiSim && sim.id !== simId);
                    if (isImeiSimDuplicate) {
                        openModal('Error de Duplicado', '<p>El IMEI de la SIM que ingresaste ya existe en el sistema.</p>');
                        return;
                    }

                    // 2. Check for conflict
                    const conflictingSim = assignedGpsId ? state.sims.find(s => s.assignedGpsId === assignedGpsId && s.id !== simId) : null;

                    const proceedWithSave = async () => {
                        // Unlink conflicting SIM if it exists
                        if (conflictingSim) {
                            await dbService.update('sims', conflictingSim.id, { assignedGpsId: '' });
                        }

                        // Unlink current SIM from its old GPS if it's being moved
                        if (simId) {
                            const originalSim = state.sims.find(s => s.id === simId);
                            if (originalSim && originalSim.assignedGpsId && originalSim.assignedGpsId !== assignedGpsId) {
                                const oldGps = state.gpsDevices.find(d => d.deviceId === originalSim.assignedGpsId);
                                if (oldGps) {
                                    await dbService.update('gpsDevices', oldGps.id, { lineaSim: '', imeiSim: '' });
                                }
                            }
                        }

                        // Link current SIM to the new GPS
                        const gpsDeviceToUpdate = assignedGpsId ? state.gpsDevices.find(d => d.deviceId === assignedGpsId) : null;
                        if (gpsDeviceToUpdate) {
                            await dbService.update('gpsDevices', gpsDeviceToUpdate.id, { lineaSim: lineaSim, imeiSim: imeiSim });
                        }

                        // Save the current SIM
                        if (simId) {
                            await dbService.update('sims', simId, data);
                        } else {
                            await dbService.add('sims', data);
                        }
                        closeModal();
                    };

                    if (conflictingSim) {
                        openModal('Confirmar Reasignación', `
                            <p class="mb-4">El equipo GPS <strong>${assignedGpsId}</strong> ya tiene asignada la SIM <strong>${conflictingSim.lineaSim}</strong>.</p>
                            <p>¿Deseas reasignar la SIM actual y desvincular la anterior?</p>
                            <div class="flex justify-end space-x-2 mt-6">
                                <button id="confirm-reassign-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                                <button id="confirm-reassign-btn" class="bg-orange-600 text-white px-4 py-2 rounded-lg">Sí, Reasignar</button>
                            </div>
                        `);
                        document.getElementById('confirm-reassign-btn').onclick = proceedWithSave;
                        document.getElementById('confirm-reassign-cancel').onclick = closeModal;
                    } else {
                        await proceedWithSave();
                    }
                };

                modalContainer.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.dataset.id;
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    if (form.id === 'sim-form') {
                        await handleSimFormSubmit(form, id, data);
                        return; 
                    }

                    if(form.id === 'gps-form') {
                        data.isSenuelo = formData.has('isSenuelo');
                        if (data.isSenuelo) {
                            data.status = 'senuelo';
                        }
                         data.accessories = {
                            sos: formData.has('sos'),
                            relay: formData.has('relay'),
                            mic: formData.has('mic'),
                            fuel: formData.has('fuel'),
                            temp: formData.has('temp'),
                            camera: formData.has('camera'),
                        };
                        const client = state.clients.find(c => c.id === data.clientId);
                        data.clientName = client ? (client.company || client.name) : '';
                        const tech = state.personnel.find(p => p.id === data.technicianId);
                        data.technicianName = tech ? tech.name : '';
                         const assigned = state.personnel.find(p => p.id === data.assignedToId);
                        data.assignedToName = assigned ? assigned.name : '';

                        if (id) {
                            await dbService.update('gpsDevices', id, data);
                        } else {
                            await dbService.add('gpsDevices', data);
                        }
                         logActivity(`Se ${id ? 'actualizó' : 'creó'} el equipo GPS: ${data.deviceId}`);
                    } else if (form.id === 'client-form') {
                        if (!id) { // Only on creation
                            data.pagosAtrasados = 0;
                        }
                        if (data.fechaDeInicioServicio && data.fechaDeCorte) {
                            const startDate = new Date(data.fechaDeInicioServicio + 'T00:00:00');
                            const cutDay = parseInt(data.fechaDeCorte);
                            let nextDueDate = new Date(startDate);
                            nextDueDate.setDate(cutDay);
                            if (nextDueDate < startDate) {
                                nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                            }
                            data.proximaFechaDeVencimiento = nextDueDate.toISOString().split('T')[0];
                        }

                         if (id) {
                            await dbService.update('clients', id, data);
                        } else {
                            await dbService.add('clients', data);
                        }
                        logActivity(`Se ${id ? 'actualizó' : 'creó'} el cliente: ${data.name}`);
                    } else if (form.id === 'vehicle-form') {
                        const client = state.clients.find(c => c.id === data.clientId);
                        data.clientName = client ? (client.company || client.name) : '';
                         if (id) {
                            await dbService.update('vehicles', id, data);
                        } else {
                            await dbService.add('vehicles', data);
                        }
                        logActivity(`Se ${id ? 'actualizó' : 'creó'} el vehículo con placas: ${data.plate}`);
                    } else if (form.id === 'personnel-form') {
                        data.isVendedor = formData.has('isVendedor');
                        data.isTecnico = formData.has('isTecnico');
                         if (id) {
                            await dbService.update('personnel', id, data);
                        } else {
                            await dbService.add('personnel', data);
                        }
                        logActivity(`Se ${id ? 'actualizó' : 'creó'} al miembro del personal: ${data.name}`);
                    } else if (form.id === 'sale-form') {
                        const saleData = {};
                        const gpsDevice = state.gpsDevices.find(g => g.id === data.gpsDeviceId);
                        const client = state.clients.find(c => c.id === data.clientId);
                        const salesRep = state.personnel.find(p => p.id === data.salesRepId);
                        const vehicle = state.vehicles.find(v => v.id === data.vehicleId);

                        // Costs
                        const gpsCost = parseFloat(data.gpsManualCost) || PRICES.PACKAGES[data.packageType] || 0;
                        const additionalAccessories = formData.getAll('accessory');
                        const includedAccessoriesFinal = formData.getAll('included_accessory');
                        const accessoriesCost = additionalAccessories.reduce((total, acc) => total + (PRICES.ACCESSORIES[acc] || 0), 0);
                        const serviceCost = PRICES.SERVICES[data.serviceType] || 0;
                        
                        const gpsDiscountPercentage = parseFloat(data.gpsDiscountPercentage) || 0;
                        const gpsDiscountAmount = (gpsCost * gpsDiscountPercentage) / 100;

                        let serviceDiscountAmount = 0;
                        let serviceDiscountPercentage = 0;
                        const primeraMensualidadGratis = formData.has('primeraMensualidadGratis');
                        let freeMonthDiscountAmount = 0;

                        if (data.serviceType.startsWith('anual')) {
                            serviceDiscountPercentage = parseFloat(data.serviceDiscountPercentage) || 0;
                            serviceDiscountAmount = (serviceCost * serviceDiscountPercentage) / 100;
                            if(primeraMensualidadGratis) {
                                freeMonthDiscountAmount = serviceCost / 12;
                            }
                        }

                        const totalCost = (gpsCost - gpsDiscountAmount) + accessoriesCost + (serviceCost - serviceDiscountAmount - freeMonthDiscountAmount);

                        saleData.saleDate = new Date().toISOString();
                        saleData.clientId = client.id;
                        saleData.clientName = client.company || client.name;
                        saleData.salesRepId = salesRep.id;
                        saleData.salesRepName = salesRep.name;
                        saleData.vehicleId = vehicle.id;
                        saleData.vehicleInfo = `${vehicle.nickname || vehicle.plate} (${vehicle.make} ${vehicle.model})`;
                        saleData.equipmentCategory = data.equipmentCategory;
                        saleData.packageType = data.packageType;
                        saleData.gpsDeviceId = gpsDevice.deviceId;
                        saleData.gpsDeviceModel = gpsDevice.model;
                        saleData.gpsCost = gpsCost;
                        saleData.includedAccessories = includedAccessoriesFinal;
                        saleData.additionalAccessories = additionalAccessories;
                        saleData.accessoriesCost = accessoriesCost;
                        saleData.serviceType = data.serviceType;
                        saleData.serviceCost = serviceCost;
                        saleData.gpsDiscountPercentage = gpsDiscountPercentage;
                        saleData.gpsDiscountAmount = gpsDiscountAmount;
                        saleData.serviceDiscountPercentage = serviceDiscountPercentage;
                        saleData.serviceDiscountAmount = serviceDiscountAmount;
                        saleData.primeraMensualidadGratis = primeraMensualidadGratis;
                        saleData.freeMonthDiscountAmount = freeMonthDiscountAmount;
                        saleData.totalCost = totalCost;

                        await dbService.add('sales', saleData);
                        await dbService.update('gpsDevices', gpsDevice.id, { status: 'cita_instalacion', clientId: client.id, clientName: saleData.clientName, vehicleId: vehicle.id });
                        logActivity(`Se registró una nueva venta para el cliente ${saleData.clientName} por un total de ${formatCurrency(totalCost)}`);
                    } else if (form.id === 'servicio-form') {
                        const client = state.clients.find(c => c.id === data.clientId);
                        const technician = state.personnel.find(p => p.id === data.technicianId);
                        const vehicle = state.vehicles.find(v => v.id === data.vehicleId);

                        data.clientName = client ? (client.company || client.name) : '';
                        data.technicianName = technician ? technician.name : '';
                        data.vehicleInfo = vehicle ? `${vehicle.nickname || vehicle.plate} (${vehicle.make} ${vehicle.model})` : '';
                        
                        if (!data.numeroActa) {
                            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                            const existingToday = state.serviciosSkytrix.filter(i => i.numeroActa && i.numeroActa.includes(today));
                            const nextId = String(existingToday.length + 1).padStart(3, '0');
                            data.numeroActa = `SKTXSERV-${today}-${nextId}`;
                        }
                        
                        await dbService.add('serviciosSkytrix', data);
                        logActivity(`Se registró un nuevo servicio (${data.tipoServicio}) para el cliente ${data.clientName}`);
                    }
                    closeModal();
                });
            };

            const ensureDefaultUsersExist = async () => {
                // Check for AdminSKX
                const adminQuery = query(collection(db, dbService.getCollectionPath('personnel')), where("usuario", "==", "AdminSKX"));
                const adminSnapshot = await getDocs(adminQuery);
                if (adminSnapshot.empty) {
                    console.log("Admin user not found, creating one...");
                    const adminUser = {
                        name: "Administrador del Sistema",
                        usuario: "AdminSKX",
                        contrasena: "SKX.Hinder2011ñ",
                        rolUsuario: "Master",
                        isVendedor: true,
                        isTecnico: true,
                        type: "activo",
                        email: "",
                        phone: ""
                    };
                    await dbService.add('personnel', adminUser);
                    logActivity("Usuario Administrador por defecto ha sido creado.");
                }

                // Check for IvanJ
                const ivanQuery = query(collection(db, dbService.getCollectionPath('personnel')), where("usuario", "==", "IvanJ"));
                const ivanSnapshot = await getDocs(ivanQuery);
                if (ivanSnapshot.empty) {
                    console.log("IvanJ user not found, creating one...");
                    const ivanUser = {
                        name: "Iván Jiménez",
                        usuario: "IvanJ",
                        contrasena: "Ne0lucard.Skytrix92",
                        rolUsuario: "Administrador",
                        isVendedor: true,
                        isTecnico: true,
                        type: "activo",
                        email: "",
                        phone: "777 106 9645"
                    };
                    await dbService.add('personnel', ivanUser);
                    logActivity("Usuario Iván Jiménez ha sido creado.");
                }

                // Check for PatricioG
                const patricioQuery = query(collection(db, dbService.getCollectionPath('personnel')), where("usuario", "==", "PatricioG"));
                const patricioSnapshot = await getDocs(patricioQuery);
                if (patricioSnapshot.empty) {
                    console.log("PatricioG user not found, creating one...");
                    const patricioUser = {
                        name: "Patricio González",
                        usuario: "PatricioG",
                        contrasena: "Plogico123",
                        rolUsuario: "Administrador",
                        isVendedor: true,
                        isTecnico: true,
                        type: "activo",
                        email: "",
                        phone: "777 343 1653"
                    };
                    await dbService.add('personnel', patricioUser);
                    logActivity("Usuario Patricio González ha sido creado.");
                }
            };

            const handleLoginAttempt = async (username, password) => {
                const loginForm = document.getElementById('login-form');
                const submitButton = loginForm.querySelector('button[type="submit"]');
                const loadingOverlay = document.getElementById('login-loading-overlay');
                const errorP = document.getElementById('login-error');

                // Show loading state
                submitButton.disabled = true;
                loadingOverlay.classList.remove('hidden');
                errorP.textContent = '';

                if (!state.isAuthReady) {
                    errorP.textContent = 'El sistema de autenticación no está listo. Intente de nuevo.';
                    submitButton.disabled = false;
                    loadingOverlay.classList.add('hidden');
                    return;
                }
                
                // Use a small delay to make the transition feel smoother
                setTimeout(async () => {
                    const q = query(collection(db, dbService.getCollectionPath('personnel')), where("usuario", "==", username), where("contrasena", "==", password));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = { id: userDoc.id, ...userDoc.data() };
                        initApp(userData);
                    } else {
                        errorP.textContent = 'Usuario o contraseña incorrectos.';
                        submitButton.disabled = false;
                        loadingOverlay.classList.add('hidden');
                    }
                }, 500);
            };

            const handleLogout = async () => {
                await signOut(auth);
                state.currentUser = null;
                state.isAuthReady = false;
                dbService.detachListeners();

                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('login-form').reset();
                document.getElementById('login-error').textContent = '';
                document.getElementById('login-loading-overlay').classList.add('hidden');
                document.getElementById('login-form').querySelector('button[type="submit"]').disabled = false;
                
                // Re-initialize anonymous auth for the login page
                initAuth();
            };

            // --- INITIALIZATION ---
            const initApp = (user) => {
                state.currentUser = user;
                
                document.getElementById('user-id-display').textContent = `Usuario: ${state.currentUser.name}`;
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                // Role-based visibility
                if (state.currentUser.rolUsuario === 'Estándar Técnicos') {
                    document.getElementById('nav-contrato-de-servicios').style.display = 'none';
                } else {
                    document.getElementById('nav-contrato-de-servicios').style.display = 'flex';
                }

                dbService.attachListeners();
                setupEventListeners();
                navigateTo('dashboard');
            };

            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Authentication failed:", error);
                    document.getElementById('login-error').textContent = 'No se pudo conectar con el servidor de autenticación.';
                }
            };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.userId = user.uid;
                    state.isAuthReady = true;
                    console.log("Firebase authenticated with UID:", user.uid);
                    await ensureDefaultUsersExist();
                } else {
                    state.isAuthReady = false;
                    state.currentUser = null;
                }
            });

            // Setup login form listener
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                handleLoginAttempt(username, password);
            });

            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            lucide.createIcons();
            initAuth();
        });
    </script>
</body>
</html>
